## 马士兵金融-前端文档

> 本项目采用的前端框架为VUE，配搭Element UI组件库，以及基于前两者的实现的vue-admin-template中后台方案。

### 1.项目搭建

#### 1.1 下载vue-admin-template集成环境

[vue-admin-template](https://gitee.com/panjiachen/vue-admin-template)

![1625981105196](image\5C1625981105196.png)

#### 1.2 运行项目

将项目添加到VScode中，运行终端（以上步骤如有不明白，可以看项目简介文档有图例）

```
# 进入项目目录
cd vue-admin-template

# 安装依赖
npm install

# 建议不要直接使用 cnpm 安装依赖，会有各种诡异的 bug。可以通过如下操作解决 npm 下载速度慢的问题
npm install --registry=https://registry.npm.taobao.org

# 启动服务
npm run dev
```

![1625982487779](image\5C1625982487779.png)

启动服务后，会自动调用系统默认游览器打开登录主页(没自动打开则手动复制地址打开)

![1625982585301](image\5C1625982585301.png)



----

点击login就可以登录到后台

![1625982664631](image\5C1625982664631.png)

---

#### 1.3 项目其他依赖安装

1.3.1 Echarts (数据可视化)

> ECharts 是一个使用 JavaScript 实现的开源可视化库，涵盖各行业图表，满足各种需求。
>
> ECharts 遵循 Apache-2.0 开源协议，免费商用。

 在项目中安装Echarts

进入终端，项目目录下输入：npm install echarts(如果刚刚运行了项目，可以按ctrl+C退出项目)

![1625983196046](image\5C1625983196046.png)

在vue上挂载Echarts

> 目录 src-main.js

![1625983217423](image\5C1625983217423.png)

#### 1.4 修改请求数据的配置

模板默认请求的项目内置的mock数据，我们修改配置来请求Python的Flask服务器

打开项目根目录下面的vue.config.js

注销掉请求本地mock数据并添加代理，

![1625984997335](image\5C1625984577767.png)

```javascript
proxy: {
      [process.env.VUE_APP_BASE_API]: {
        target: 'http://127.0.0.1:5000',
        changeOrigin: true,
        pathRewrite: {
          ['^' + process.env.VUE_APP_BASE_API]: ''
        }
      }
    },
```

> src-api-user.js

修改用户登录请求的api

![1625985817218](image\5C1625985817218.png)

再次启动服务，打开首页，点击登录（这里的前提是后台的登录接口已经写好了，才有以下提示）

![1625985947334](image\5C1625985947334.png)

![1625985995800](image\5C1625985995800.png)

我们可以看到，请求成功，默认的账号密码不对。修改成功。

#### 1.5 路由配置

##### 1.5.1 路由配置说明

> src-router-index.js

路由都在这个文件里面配置

- constantRoutes为默认路由（所有人都可以访问），比如前台页面登录，注册等。

![1632466862050](image\5C1632466862050.png)

- 异步路由（根据登录用户的权限组异步生成的路由）

  ![1632467214765](image\5C1632467214765.png)

  ![1632467653013](image\5C1632467653013.png)

##### 1.5.2 动态路由

> (按登录用户的身份不同，加载不同的路由，实现操作菜单的不同)
>
> 下面是**管理员**登录，个人中心的操作菜单
>
> ![1632460031722](image\5C1632460031722.png)
>
> 下面是**普通用户**登录，个人中心的操作菜单
>
> ![1632460096958](image\5C1632460096958.png)

- 修改路由守卫内容

  ![1632461113924](image\5C1632461113924.png)

  ```javascript
  if (hasToken) {
      if (to.path === '/login') {
        // if is logged in, redirect to the home page
        next({ path: '/' })
        NProgress.done()
      } else {
        //  从 vuex里面获取 权限组 如果有roles并且roles对象大于1个  为真的话说明已经登录过，直接跳下一步 
        const hasRoles = store.getters.roles && store.getters.roles.length > 0
        if (hasRoles) {
          next()
        } else {
          //  如果没有Roles，则请求API获取用户信息，拿到roles
          try {
            // const hasGetUserInfo = store.getters.name
            const { roles } = await store.dispatch('user/getInfo')
            
            // 根据Roles创建 使用权限筛选的路由
            const accessRoutes = await store.dispatch('permission/generateRoutes', roles)
  
            // router添加创建的路由
            router.addRoutes(accessRoutes)
  
            next({ ...to, replace: true })
  
          } catch (error) {
            // remove token and go to login page to re-login
            await store.dispatch('user/resetToken')
            Message.error(error || 'Has Error')
            next(`/login?redirect=${to.path}`)
            NProgress.done()
          }
        }
      }
  ```

- 新建创建路由的方法

  > src-store-modules下创建permission.js文件

  ![1632464171114](image\5C1632464171114.png)

  文件代码

  ```javascript
  import { asyncRoutes, constantRoutes } from '@/router'
  
  /**
   * Use meta.role to determine if the current user has permission
   * @param roles
   * @param route
   */
  function hasPermission(roles, route) {
    // 如果route下面没有mete也没有roles，则视为全部权限访问
    // 否则 用route的roles来遍历用户的 roles判断是否包含，包含则有权限。
    // 比如 route的权限是 ccc ,ddd  用户的权限是 aaa,bbb,ccc（可以视为3个部门） 则有权限访问， 
    if (route.meta && route.meta.roles) {
      return roles.some(role => route.meta.roles.includes(role))
    } else {
      return true
    }
  }
  
  /**
   * Filter asynchronous routing tables by recursion
   * @param routes asyncRoutes
   * @param roles
   */
  export function filterAsyncRoutes(routes, roles) {
    const res = []
    // 遍历筛选路由表，判断是否有权限,有权限则添加
    routes.forEach(route => {
      const tmp = { ...route }
      if (hasPermission(roles, tmp)) {
        if (tmp.children) {
          tmp.children = filterAsyncRoutes(tmp.children, roles)
        }
        res.push(tmp)
      }
    })
  
    return res
  }
  
  const state = {
    routes: [],
    addRoutes: []
  }
  
  const mutations = {
    SET_ROUTES: (state, routes) => {
      state.addRoutes = routes
      // 合并路由
      state.routes = constantRoutes.concat(routes)
      console.log('routes', state.routes)
    }
  }
  
  const actions = {
    // 创建筛选权限的路由
    generateRoutes({ commit }, roles) {
      return new Promise(resolve => {
        let accessedRoutes
        // 如果roles包含了 admin 权限路由直接等于 asyncRoutes
        if (roles.includes('admin')) {
          accessedRoutes = asyncRoutes || []
        } else {
          // 如果不是管理员 则进行路由过滤
          accessedRoutes = filterAsyncRoutes(asyncRoutes, roles)
        }
        commit('SET_ROUTES', accessedRoutes)
        resolve(accessedRoutes)
      })
    }
  }
  
  export default {
    namespaced: true,
    state,
    mutations,
    actions
  }
  
  
  ```

  在store中导入permission

  ![1632466471048](image\5C1632466471048.png)

---

### 2.首页搭建

#### 2.1.1 顶栏

创建顶部导航栏组件（<u>前台每个页面都需要展示的顶栏和导航栏，所以我们提取为公用的组件</u>）

![1632449734062](image\5C1632449734062.png)

![1625987045597](image\5C1625987045597.png)

在components下面，创建HeaderBar文件夹，在里面创建index.vue

template里面就分为上下2个容器，顶栏和导航栏

```vue
<template>
  <!-- 顶部组件  -->
  <div class="head">
    <!-- 顶栏 -->
    <div class="headerBar">
      <div class="left-title">
        <span class="site-title">马士兵金融</span>
      </div>
      <!-- 右菜单 -->
      <div class="right-menu">
        <!-- 未登录，显示注册，登录 -->
        <div v-if="!token">
          <router-link :to="{ path: '/register' }">
            <span>注册</span>
          </router-link>
          <router-link :to="{ path: '/login' }">
            <span>登录</span>
          </router-link>
        </div>
        <!-- 登录了，显示个人中心，下拉菜单里有我的账户和退出选项 -->
        <div v-else>
          <span>{{name}}</span>
          <el-dropdown>
            <span class="el-dropdown-link">
              个人中心<i class="el-icon-arrow-down el-icon--right"></i>
            </span>
            <el-dropdown-menu slot="dropdown">
              <router-link :to="{ path: '/dashboard' }"><el-dropdown-item>我的账户</el-dropdown-item></router-link>
              <el-dropdown-item @click.native="logout">退出</el-dropdown-item>
            </el-dropdown-menu>
          </el-dropdown>
        </div>
      </div>
    </div>
    <div class="line">
      <!-- 导航栏 -->
      <el-menu
        :default-active="curIndex"
        class="el-menu-demo"
        mode="horizontal"
        @select="handleSelect"
        background-color="#fff"
        text-color="#000"
        active-text-color="#ffd04b"
      >
        <el-menu-item @click="goHome" index="1">首页</el-menu-item>
        <el-menu-item @click="goLoan" index="2">我要借款</el-menu-item>
        <el-menu-item @click="goInvest" index="3">我要投资</el-menu-item>
        <el-menu-item @click="goDashBoard" index="4" v-if="token">我的账户</el-menu-item>
      </el-menu>
    </div>
  </div>
</template>

<script>
import{ mapGetters } from 'vuex'
export default {
  props: ['curIndex'],
  data() {
    return {
      activeIndex: "1",
    };
  },
  methods: {
    handleSelect(key, keyPath) {
      console.log(key, keyPath);
    },
    goLoan() {
      this.$router.replace({ path: "/loanApply" });
    },
    goHome() {
      this.$router.replace({ path: "/" });
    },
    goInvest() {
      this.$router.replace({path: "/Invest" });
    },
    goDashBoard(){
      this.$router.replace({ path: "/dashboard" });
    },
    async logout() {
      await this.$store.dispatch('user/logout')
      this.$router.push(`/login?redirect=${this.$route.fullPath}`)
    }
    
  },
  computed:{
      ...mapGetters(['token','name'])
  }
};
</script>

<style lang="scss" scoped>
.site-title {
  font-size: 22px;
  display: table-cell;
  vertical-align: middle;
}
.headerBar {
  padding: 0px 15px;
  box-sizing: border-box;
  background-color: #cc0000;
  color: #ffffff;
  display: flex;
  justify-content: space-between;
  max-width: 1140px;
  height: 40px;
  align-items: center;
}

.right-menu {
  display: flex;
  align-items: center;
  flex-direction: row;
  span {
    margin: 0px 8px;
  }
}

.el-dropdown-link {
  cursor: pointer;
  color: #ffffff;
  font-size: 14px;
}
.el-icon-arrow-down {
  font-size: 12px;
}

.login-right-img {
  padding: 120px 0;
  text-align: center;
  width: auto;
  height: auto;
}

.el-menu-demo {
  background-color: transparent;
}

.line {
  border: 1px solid rgb(199, 199, 199);
}
</style>
```

#### 2.1.2 登录页面

![1632449984771](C:\Users\NINGMEI\AppData\Roaming\Typora\typora-user-images\1632449984771.png)

> ###### 流程描述
>
> 1.用户在前台点击【登录】按钮，进入【用户登录页面】
>
> 2.用户输入用户名或手机号、密码，点击【登录】按钮。若登录信息填写正确，通过后台验证后，则登录成功，跳转个人中心主页。若用户在未登录的状态访问需要登录才能查看的页面，会拦截到登录页面，登录后再重定向到之前访问的页面

- 修改登录功能请求的相关API和方法

  ![1632461478895](image\5C1632461478895.png)

  ```javascript
  // 登录
  export function login(data) {
    return request({
      url: '/user/login',
      method: 'post',
      data
    })
  }
  
  // 获取用户信息
  export function getInfo(token) {
    return request({
      url: '/user/userInfo',
      method: 'get',
      params: { token }
    })
  }
  
  // 退出登录
  export function logout() {
    return request({
      url: '/user/loginOut',
      method: 'post'
    })
  }
  ```

  ![1632461576237](image\5C1632461576237.png)

  ```javascript
  login, logout, getInfo
  ```

  ![1632462801494](image\5C1632462801494.png)

  ```javascript
  const getDefaultState = () => {
    return {
      token: getToken(),
      name: '',
      avatar: '',
      bankCardList:[],  // 银行卡列表
      accountStatus:null, // 用户账号信息
      accountInfo:{},     // 用户账户信息 （资产相关）
      roles:[],           // 权限组
      invite_code:''      // 注册邀请码
    }
  }
  ```

  ![1632463031931](image\5C1632463031931.png)

  ```javascript
  const mutations = {
    RESET_STATE: (state) => {
      Object.assign(state, getDefaultState())
    },
    SET_TOKEN: (state, token) => {
      state.token = token
    },
    SET_ROLES: (state, roles) => {
      state.roles = roles         // 权限组
    },
    SET_NAME: (state, name) => {
      state.name = name           // name
    },
    SET_AVATAR: (state, avatar) => {
      state.avatar = avatar       // 头像
    },
    SET_CARDLIST: (state, list) => {
      state.bankCardList = list   // 存储用户银行卡列表
    },
    SET_ACCOUNTSTATUS: (state, status) => {
      state.accountStatus = status
    },
    SET_ACCOUNTINFO: (state, status) => {
      state.accountInfo = status
    },
    SET_PAYPWD: (state, status) => {
      state.accountStatus.payPwdStatus = 1  // 更改支付密码设置状态
    },
    SET_REALNAME: (state, status) => {
      state.accountStatus.realNameAuth = 1  // 更改实名认证状态
    },
    SET_INVITECODE: (state, code) => {
      state.invite_code = code              // 邀请注册码
    },
  }
  ```

  ![1641526315687](image\5C1641526315687.png)

  ```javascript
  const getters = {
    sidebar: state => state.app.sidebar,
    device: state => state.app.device,
    token: state => state.user.token,
    invite_code: state => state.user.invite_code,
    avatar: state => state.user.avatar,
    name: state => state.user.name,
    bankCardList:state => state.bankCard.bankCardList,
    accountStatus:state => state.user.accountStatus,
    accountInfo:state => state.user.accountInfo,
    productList:state => state.invest.productList,
    roles:state => state.user.roles,
    permission_routes: state => state.permission.routes,
  }
  export default getters
  
  ```

  ![1632462405025](image\5C1632462405025.png)

  ```javascript
    // get user info
    getInfo({ commit, state }) {
      return new Promise((resolve, reject) => {
        getInfo(state.token).then(response => {
          const { data } = response
          if (!data) {
            return reject('Verification failed, please Login again.')
          }
          // 从返回数据获取 用户权限组，名字，用户详细信息
          const { roles, name, userInfoData } = data
          commit('SET_ROLES', roles)  // 保存用户权限组到vuex
          commit('SET_NAME', name)    // 保存用户NAME组到vuex
          commit('SET_INVITECODE', userInfoData.invite_code) // 保存用户注册邀请码到vuex
          commit('SET_ACCOUNTSTATUS', data.userInfoData)     // 保存用户详细信息到vuex
          commit('SET_ACCOUNTINFO', data.accountInfo)        // 保存用户账户信息到vuex
          const tem_avatar = userInfoData.avatar || 'baseAvatar.jpg'  //获取用户头像或者默认头像
          commit('SET_AVATAR', tem_avatar)    // 保存头像到vuex
          resolve(data)
        }).catch(error => {
          reject(error)
        })
      })
    },
  ```


修改之前的登录页面，删除掉之前template内容，js和css样式，引入顶栏组件，编写页面

> src-views-login-index.vue

```vue
<template>
  <el-container class="login-container">
    <!-- 顶部组件 -->
    <el-header>
      <HearderBar :login_status="isLogin"></HearderBar>
    </el-header>
    <!-- Container 容器组件 左右布局-->
    <el-main class="body-box">
      <el-row class="row-box">
        <el-col :span="14" :xs="24" :sm="24" :md="14">
          <div class="login-box">
            <!--  登录表单 -->
            <!-- ref 注册引用
               :model 表单绑定的对象
               ：rules 绑定的验证器对象
           -->
            <el-form
              ref="loginForm"
              :model="loginForm"
              :rules="loginRules"
              class="login-form"
              auto-complete="on"
              label-position="left"
            >
              <div class="title-container">
                <h3 class="title">登录</h3>
              </div>

              <el-form-item prop="username">
                <span class="svg-container">
                  <svg-icon icon-class="user" />
                </span>
                <el-input
                  ref="username"
                  v-model="loginForm.username"
                  placeholder="用户名"
                  name="username"
                  type="text"
                  tabindex="1"
                  auto-complete="on"
                />
              </el-form-item>

              <el-form-item prop="password">
                <span class="svg-container">
                  <svg-icon icon-class="password" />
                </span>
                <el-input
                  :key="passwordType"
                  ref="password"
                  v-model="loginForm.password"
                  :type="passwordType"
                  placeholder="密码"
                  name="password"
                  tabindex="2"
                  auto-complete="on"
                  @keyup.enter.native="handleLogin"
                />
                <span class="show-pwd" @click="showPwd">
                  <svg-icon
                    :icon-class="
                      passwordType === 'password' ? 'eye' : 'eye-open'
                    "
                  />
                </span>
              </el-form-item>

              <el-button
                :loading="loading"
                type="primary"
                style="width: 100%; margin-bottom: 30px"
                @click.native.prevent="handleLogin"
                >登录</el-button
              >
            </el-form>
          </div>
        </el-col>
        <el-col :span="10" :md="10" class="hidden-sm-and-down"
          ><div class="login-right">
            <el-image
              :src="require('@/assets/login-img.png')"
              lazy
            ></el-image></div
        ></el-col>
      </el-row>
    </el-main>
  </el-container>
</template>

<script>
import HearderBar from "@/components/HeaderBar/index"; //顶栏组件
import "element-ui/lib/theme-chalk/display.css";
export default {
  name: "Login",
  components: {
    HearderBar, // 注册组件 (引入的组件需要这里注册)
  },
  data() {
    // 密码验证器 长度不小于6位
    const validatePassword = (rule, value, callback) => {
      if (value.length < 6) {
        callback(new Error("密码不能少于6位"));
      } else {
        callback();
      }
    };
    return {
      // 登录表单的数据源对象
      loginForm: {
        username: "",
        password: "",
      },
      // 验证器对象
      loginRules: {
        username: [
          { required: true, trigger: "blur" ,message: "请输入用户名"}, // required 是否必填  trigger 触发验证的方式 blur 离开触发
        ],
        password: [
          { required: true, trigger: "blur", validator: validatePassword }, // validator 对应上面的密码验证器
        ],
      },
      loading: false, //是否加载中状态
      passwordType: "password", //是否显示密码
      redirect: undefined, // 重定向
      isLogin: false, // 是否已登录 给子组件传递
    };
  },
  watch: {
    $route: {
      handler: function (route) {
        this.redirect = route.query && route.query.redirect;
      },
      immediate: true,
    },
  },
  methods: {
    // 是否显示密码
    showPwd() {
      if (this.passwordType === "password") {
        this.passwordType = "";
      } else {
        this.passwordType = "password";
      }
      this.$nextTick(() => {
        this.$refs.password.focus();
      });
    },
    // 提交登录
    handleLogin() {
      this.$refs.loginForm.validate((valid) => {
        // 获取到表单 判断是否通过表单验证
        if (valid) {
          this.loading = true;
          // 异步调用 请求登录的api
          this.$store
            .dispatch("user/login", this.loginForm)
            .then(() => {
              // 成功返回，跳转到重定向路径或者根路径
              console.log("this.redirect", this.redirect);
              this.$router.push({ path: this.redirect || "/" });
              this.loading = false;
            })
            .catch(() => {
              this.loading = false;
            });
        } else {
          console.log("error submit!!");
          return false;
        }
      });
    },
  },
};
</script>

<style lang="scss">
/* 修复input 背景不协调 和光标变色 */
/* Detail see https://github.com/PanJiaChen/vue-element-admin/pull/927 */

// $bg: #283443;
$light_gray: #fff;
$cursor: #fff;

$bg: #e9eef3;
$dark_gray: #c5e9fd;
$light_gray: #eee;

@supports (-webkit-mask: none) and (not (cater-color: $cursor)) {
  .login-container .el-input input {
    color: $cursor;
  }
}

/* reset element-ui css */
.login-container {
  max-width: 1140px;
  height: 100%;
  margin: 0 auto;

  .el-header {
    padding: 0px;
    width: 100%;
    height: auto !important;
  }

  .body-box {
    background-color: $bg;
    width: 100%;
    height: 100%;
    padding: 0px;

    .row-box {
      height: 100%;

      .el-col {
        height: 100%;
        .el-image{
              padding: 120px 10px
        }
      }
    }

    .login-box {
      height: 100%;
      width: 100%;
      background-color: $bg;
      // overflow: hidden;
      border-right: 1px solid rgb(175, 175, 175);
      padding-top: 120px;
      // text-align: center;
      display: flex;
      justify-content: center;

      .login-form {
        position: relative;
        width: 520px;
        max-width: 100%;

        overflow: hidden;
      }

      .el-form-item {
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: #2d3a4b7a;
        border-radius: 5px;
        color: #4d4d4d;
      }

      .svg-container {
        padding: 6px 5px 6px 15px;
        color: $dark_gray;
        vertical-align: middle;
        width: 30px;
        display: inline-block;
      }

      .title-container {
        position: relative;

        .title {
          font-size: 26px;
          color: #000;
          margin: 0px auto 40px auto;
          text-align: center;
          font-weight: bold;
        }
      }

      .show-pwd {
        position: absolute;
        right: 10px;
        top: 7px;
        font-size: 16px;
        color: $dark_gray;
        cursor: pointer;
        user-select: none;
      }

      .el-input {
        display: inline-block;
        height: 47px;
        width: 85%;

        input {
          background: transparent;
          border: 0px;
          -webkit-appearance: none;
          border-radius: 0px;
          padding: 12px 5px 12px 15px;
          color: $light_gray;
          height: 47px;
          caret-color: $cursor;

          &:-webkit-autofill {
            box-shadow: 0 0 0px 1000px #9098a3 inset !important;
            -webkit-text-fill-color: $cursor !important;
          }
        }
      }
    }
  }
}
</style>

```

---

#### 2.1.3 注册页面



> #### 流程描述
>
> - 点击顶栏注册，跳转到注册页面
>
> - 填入账号名，密码，手机号，验证码点击注册，请求服务器进行注册
>
> - 默认发送验证码的按钮为禁用，填入合法手机号后，会调用接口验证手机号是否已注册，若手机号已使用会进行提示，若未使用，则通过验证，发送验证码按钮恢复正常
>
> - ![1632450395452](image\5C1632450395452.png)
>
> - 点击发送验证码，调用发送验证码的接口，验证码按钮变为禁用，并出现倒计时，以防止重复提交发送验证码，倒计时结束可以重新发送验证码
>
>   ![1632450449512](image\5C1632450449512.png)
>
> - 填入 验证码后，其他表单项都通过验证号，点击注册请求注册接口，注册成功页面会有message提示，告知即将跳转至登录页面，并禁用注册按钮。若注册失败会进行错误提示。
>
>   ![1632450504049](image\5C1632450504049.png)
>

在src目录下，创建register文件夹，下面创建index.vue文件

![1625990402402](image\5C1625990402402.png)

```vue
<template>
  <el-container>
    <!-- 顶部组件 -->
    <el-header>
      <HearderBar :login_status="isLogin"></HearderBar>
    </el-header>
    <!-- Container 容器组件 左右布局-->
    <el-container class="body-box">
      <!-- 左 -->
      <el-aside width="60%">
        <!-- 卡片容器 自带阴影效果 美观 -->
        <el-card class="register-card">
          <!-- 表单 标题 -->
          <div class="register-title">
            <div class="title-container">
              <h3 class="title">账号注册</h3>
            </div>
          </div>
          <!-- 注册的表单 -->
          <div class="register-body">
            <el-form
              label-position="left"
              label-width="70px"
              :model="ruleForm"
              status-icon
              :rules="rules"
              ref="ruleForm"
              class="demo-ruleForm"
            >
              <el-form-item label="用户名" prop="username">
                <el-input v-model="ruleForm.username"></el-input>
              </el-form-item>
              <el-form-item label="密码" prop="password">
                <el-input
                  type="password"
                  v-model="ruleForm.password"
                  autocomplete="off"
                ></el-input>
              </el-form-item>
              <el-form-item label="确认密码" prop="checkPass">
                <el-input
                  type="password"
                  v-model="ruleForm.checkPass"
                  autocomplete="off"
                ></el-input>
              </el-form-item>
              <el-form-item label="手机号码" prop="phone">
                <el-input v-model.number="ruleForm.phone"></el-input>
              </el-form-item>
              <el-form-item label="验证码" prop="code">
                <el-input
                  maxLength="4"
                  v-model.number="ruleForm.code"
                  class="sort-input"
                ></el-input>
                <el-button
                  :disabled="!isRightPhone"
                  class="codeBtn"
                  @click="getCode"
                  type="primary"
                  >{{ sendBtnTxt }}</el-button
                >
              </el-form-item>
              <el-form-item label="邀请码">
                <el-input
                  maxLength="6"
                  v-model="ruleForm.invite_code"
                  class="sort-input"
                  placeholder="可为空"
                ></el-input>
              </el-form-item>
              <el-form-item>
                <el-button
                  type="primary"
                  :disabled="isSubmit"
                  @click="submitForm('ruleForm')"
                  >注册</el-button
                >
                <el-button @click="resetForm('ruleForm')">重置</el-button>
              </el-form-item>
            </el-form>
          </div>
        </el-card>
      </el-aside>
      <!-- 右 -->
      <el-main>
        <div class="login-right-img">
          <el-image :src="require('@/assets/invite.png')" lazy></el-image>
        </div>
      </el-main>
    </el-container>
  </el-container>
</template>

<script>
import HearderBar from "@/components/HeaderBar/index"; //顶栏组件
import { mapActions } from "vuex";
export default {
  name: "register",
  components: {
    HearderBar,
  },
  data() {
    // 用户名验证器
    var checkUsername = (rule, value, callback) => {
      if (!value) {
        return callback(new Error("用户名不能为空"));
      }
      setTimeout(() => {
        if (value.length > 10) {
          callback(new Error("用户名不能超过10个字符"));
        } else {
          callback();
        }
      }, 500);
    };
    // 手机号验证器
    var checkphone = (rule, value, callback) => {
      this.isRightPhone = false;
      if (!value) {
        return callback(new Error("手机号不能为空"));
      }
      setTimeout(() => {
        const regPhone = /^1[3|4|5|7|8][0-9]{9}$/;
        // 正则判断手机号是否符合规范
        if (regPhone.test(value)) {
          // 请求判断手机号是否已经注册的api
          this.checkPhone({ phone: value }).then((response) => {
            this.isRightPhone = true; // 此手机号可以获取验证码
            callback();
          });
        } else {
          callback(new Error("手机格式不正确"));
        }
      }, 500);
    };
    // 密码验证器
    var validatePass = (rule, value, callback) => {
      if (value === "") {
        callback(new Error("请输入密码"));
      } else {
        if (this.ruleForm.checkPass !== "") {
          this.$refs.ruleForm.validateField("checkPass");
        }
        callback();
      }
    };
    // 确认密码验证
    var validatePass2 = (rule, value, callback) => {
      if (value === "") {
        callback(new Error("请再次输入密码"));
      } else if (value !== this.ruleForm.password) {
        callback(new Error("两次输入密码不一致!"));
      } else {
        callback();
      }
    };
    return {
      // 注册表单对象
      ruleForm: {
        password: "",
        checkPass: "",
        username: "",
        phone: "",
        code: "",
        invite_code:''
      },
      // 注册表单验证器
      rules: {
        password: [{ validator: validatePass, trigger: "blur" }],
        checkPass: [{ validator: validatePass2, trigger: "blur" }],
        username: [{ validator: checkUsername, trigger: "blur" }],
        phone: [{ validator: checkphone, trigger: "blur" }],
        code: [
          { required: true, message: "请输入验证码", trigger: "blur" },
          { type: "number", message: "请输入4位数字验证码", trigger: "blur" },
        ],
      },
      isLogin: false,
      isSubmit: false, // 是否提交 避免重复提交
      isRightPhone: false, // 是否可以获取验证码 控制验证码的状态
      sendBtnTxt: "发送验证码",
      timer: null,
      conter: 10, //验证码恢复倒计时
    };
  },
  methods: {
    ...mapActions({ checkPhone: "user/checkPhone" }), //查询手机号是否已注册的方法
    // 提交注册表单
    submitForm(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          this.isSubmit = !this.isSubmit; // 将提交按钮设置为禁用
          this.$store
            .dispatch("user/register", this.ruleForm) // 调用请求注册api的方法
            .then(() => {
              // 注册成功通知
              this.$message({
                message: "注册成功，即将前往登录",
                type: "success",
              });
              // 3秒后重定向到 登录页面
              setTimeout(() => {
                this.$router.push("/login-new");
              }, 3000);
            })
            .catch(() => {
              this.loading = false; // 重置加载状态
              this.isSubmit = false; // 重置按钮状态
            });
        } else {
          console.log("error submit!!");
          return false;
        }
      });
    },
    // 重置表单
    resetForm(formName) {
      this.$refs[formName].resetFields();
      this.isSubmit = false;
      this.reset()
      this.isRightPhone = false;
    },
    // 获取验证码
    getCode() {
      // 禁用发送验证码按钮
      this.isRightPhone = false;
      this.$store
        .dispatch("user/getSmsCode", { phone: this.ruleForm.phone })
        .then((res) => {
          this.$notify({
            title: "验证码",
            message: res.smsCode,
            type: "success",
            duration: 5000,
          });

          // 按钮重置倒计时
          this.countDown();
        })
        .catch(() => {
          this.loading = false;
        });
    },
    // 重置按钮倒计时
    countDown() {
      this.timer = setInterval(() => {
        this.sendBtnTxt = `(${this.conter}秒)`;
        this.conter--;
        if (this.conter < 0) {
          this.reset();
        }
      }, 1000);
    },
    // 恢复验证码按钮 重置计时器
    reset() {
      this.isRightPhone = true;
      this.sendBtnTxt = "发送验证码";
      if (this.timer) {
        clearInterval(this.timer);
        this.conter = 10;
        this.timer = null;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.el-container {
  max-width: 1140px;
  margin: 0px auto;
  height: 100%;
}

.el-header {
  padding: 0px;
  background-color: #b3c0d1;
  color: #333;
  text-align: center;
  width: 100%;
  height: 40px !important;
}

.el-notification.right {
  right: 100px !important;
}

.el-aside {
  background-color: #d3dce6;
  color: #333;
  // text-align: center;
  // line-height: 200px;
  height: 100%;
}

.el-main {
  background-color: #e9eef3;
  color: #333;
  text-align: center;
  // line-height: 160px;
  width: 100%;
  height: 100%;
}

.item {
  padding: 18px 0;
}

.register-card {
  //   padding-top: 50px;
  box-sizing: border-box;
  margin: 120px auto;
  background-color: #e9eef3;
  width: 480px;
}

.login-right-img {
  padding: 110px 0;
  margin: 0px auto;
  text-align: center;
  width: 80%;
  height: 80%;
}

.sort-input {
  width: 80px;
  margin-left: 0px;
}

.register-title {
  text-align: center;
}

.el-form-item {
  .codeBtn {
    margin-left: 10px;
    width: 30%;
  }
}
</style>
```

为注册页面添加路由。 @符号为src目录的简写

![1625990620012](image\5C1625990620012.png)

在权限文件里把注册加入到白名单里，不然会路由守卫拦截重定向到登录页面。

![1625991551303](image\5C1625991009696.png)

现在我们点击顶栏的登录和注册按钮，可在2个页面之间正常跳转。

#### 2.1.4 我要借款

> - 借款申请页面，必须要登录才能进行提交，未登录提交会弹出提示，未登录。跳转到登录界面。
>
> ![1632451881798](image\5C1632451881798.png)
>
> - 登录后，借款人自动填入当前登录用户的用户名，切不可更改。
>
> - 填入借款金额，选择了借款期限，点击还款计划可用查看当前借款对应的还款计划。
>
> ![1632452045499](image\5C1632452045499.png)
>
> - 点击发送验证码，给当前用户的手机发送短信验证码，填入验证码即可提交借款申请

---

- 创建组件 在src目录下，创建loanapply文件夹，下面创建index.vue文件

![1632452380057](image\%5C1632452380057.png)

配置路由

> src-router-index.js

![1632452567843](image\5C1632452567843.png)

---

- 编写页面

先添加请求接口的API和方法

![1632452928633](image\5C1632452928633.png)

![1632452981833](C:\Users\NINGMEI\AppData\Roaming\Typora\typora-user-images\1632452981833.png)

![1632453025315](image\5C1632453025315.png)

组件内容

```vue
<template>
  <el-container>
    <el-header>
      <HearderBar curIndex="2"></HearderBar>
    </el-header>
    <el-main class="loan-main">
      <div class="body-box">
        <div class="loan-box">
          <div class="title">借款申请表</div>
          <div class="form-box">
            <el-form
              ref="loan_form"
              :rules="rules"
              :model="loan_form"
              label-width="80px"
            >
              <el-form-item label="借款人" prop="holder">
                <el-input maxLength="10" v-model="loan_form.holder" :readonly='true'></el-input>
              </el-form-item>
              <el-form-item label="借款金额" prop="amount">
                <el-input
                  maxLength="6"
                  v-model="loan_form.amount"
                  @change="onAmountChange"
                ></el-input>
              </el-form-item>
              <el-form-item label="还款方式" prop="radio">
                <el-radio v-model="loan_form.radio" label="1"
                  >等额本金</el-radio
                >
              </el-form-item>
              <el-form-item label="借款利率" prop="radio">
                <span>年利率{{ yearRate }}%</span>
              </el-form-item>
              <el-form-item label="借款期限" prop="loanMonth">
                <el-dropdown @command="selectDate">
                  <span class="el-dropdown-link">
                    {{ repay }}<i class="el-icon-arrow-down el-icon--right"></i>
                  </span>
                  <el-dropdown-menu slot="dropdown">
                    <el-dropdown-item command="3">3个月</el-dropdown-item>
                    <el-dropdown-item command="6">6个月</el-dropdown-item>
                    <el-dropdown-item command="12">12个月</el-dropdown-item>
                  </el-dropdown-menu>
                </el-dropdown>
              </el-form-item>
              <el-form-item label="还款计划" prop="phone">
                <el-popover placement="right" trigger="click">
                  <el-table :data="repayPlanData">
                    <el-table-column
                      width="150"
                      property="date"
                      label="还款日期"
                    ></el-table-column>
                    <el-table-column
                      width="300"
                      property="repayMount"
                      label="还款金额"
                    ></el-table-column>
                  </el-table>
                  <el-button slot="reference">详情点击</el-button>
                </el-popover>
              </el-form-item>
              <el-form-item v-if="token" label="手机号码" prop="radio">
                <span>{{accountStatus.phone}}</span>
              </el-form-item>
              <el-form-item label="验证码" prop="code">
                <el-input
                  maxLength="4"
                  v-model.number="loan_form.code"
                  class="sort-input"
                ></el-input>
                <el-button
                  :disabled="!canSendSms"
                  class="codeBtn"
                  @click="getCode"
                  type="primary"
                  >{{ sendBtnTxt }}</el-button
                >
              </el-form-item>
              <el-form-item>
                <el-button type="primary" @click="loginVerify"
                  >提交借款申请</el-button
                >
              </el-form-item>
            </el-form>
          </div>
        </div>
        <div class="bg-img">
          <el-image :src="require('@/assets/loan-bg.png')"></el-image>
        </div>
      </div>
    </el-main>
  </el-container>
</template>

<script>
import HearderBar from "@/components/HeaderBar/index"; //顶栏组件
import { mapGetters } from "vuex";
export default {
  name: "register",
  components: {
    HearderBar,
  },
  data() {
    // 用户名验证器
    var checkUsername = (rule, value, callback) => {
      if (!value) {
        return callback(new Error("用户名不能为空"));
      }
      setTimeout(() => {
        if (value.length > 10) {
          callback(new Error("用户名不能超过10个字符"));
        } else {
          callback();
        }
      }, 500);
    };
    return {
      loan_form: {
        holder: "", // 借款人
        amount: "", // 金额
        // phone: "", // 手机号
        loanMonth: null, // 借款月数
        code: "",
        radio: "1",
      },
      repayPlanData: [],
      sendBtnTxt: "发送验证码",
      repay: "请选择",
      conter: 10, //验证码恢复倒计时
      canSendSms: true, // 是否可以获取验证码 控制验证码的状态
      yearRate: 11,
      // 验证器对象
      rules: {
        holder: [
          { validator: checkUsername, trigger: "blur" }, // required 是否必填  trigger 触发验证的方式 blur 离开触发
        ],
        amount: [
          { required: true, trigger: "blur", message: "请输入金额" }, //
        ],
        loanMonth: [
          {
            required: true,
            trigger: ["change"],
            message: "请选择借款期数",
          },
        ],
        code: [
          {
            required: true,
            trigger: ["blur", "change"],
            message: "请填写验证码",
          },
        ],
        radio: [
          {
            required: true,
            trigger: ["blur", "change"],
            message: "请选择性别",
          },
        ],
      },
    };
  },
  methods: {
    selectDate(command) {
      this.loan_form.loanMonth = command;
      if (command == 3) {
        this.repay = "3个月";
      } else if (command == 6) {
        this.repay = "6个月";
      } else if (command == 12) {
        this.repay = "12个月";
      }
      this.getRePayPlan();
    },
    onSubmit(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          this.$store
            .dispatch("loan/loanApply", this.loan_form)
            .then(() => {
              this.$message({
                message: "提交借款申请成功",
                type: "success",
              });
            })
            .catch(() => {});
        } else {
        }
      });
    },
    getRePayPlan() {
      if (this.loan_form.loanMonth && this.loan_form.amount) {
        var monthCost = Math.floor(
          this.loan_form.amount / this.loan_form.loanMonth * 100 
        ) /100 ;
        var monthInterest = 0;
        var monthRate = Math.floor(this.yearRate / 100 / 12 * 10000) / 10000;
        var totalAmount = 0;
        this.repayPlanData = [];
        for (var i = 1; i <= this.loan_form.loanMonth; i++) {
          monthInterest = Math.floor(
            ((this.loan_form.amount - monthCost * (i - 1)) * monthRate) * 100
          ) / 100;
          totalAmount = Math.floor((monthCost + monthInterest) * 100) /100;
          var now = new Date();
          var year = now.getFullYear();
          var month = now.getMonth() + i + 1;
          var date = now.getDate();
          var repayDate = `${year}年${month}月${date}日`;
          var repayInfo = `本金:${monthCost},利息:${monthInterest},还款总额(本金+利息):${totalAmount}`;
          var repayItem = { date: repayDate, repayMount: repayInfo };
          this.repayPlanData.push(repayItem);
        }
      }
    },
    // 登录 验证
    loginVerify() {
      if (!this.token) {
        this.$confirm("请先登录", "提示", {
          confirmButtonText: "去登录",
          cancelButtonText: "取消",
          type: "warning",
        }).then(() => {
          this.$router.push({ path: "/login" });
        });
      } else {
        this.onSubmit("loan_form");
      }
    },
    // 获取验证码
    getCode() {
      // 禁用发送验证码按钮
      
      if(this.canSendSms){
        this.canSendSms = false;
          this.$store
        .dispatch("user/getSmsCode", { phone: this.accountStatus.phone })
        .then((res) => {
          this.$notify({
            title: "验证码",
            message: res.smsCode,
            type: "success",
            duration: 5000,
          });

          // 按钮重置倒计时
          this.countDown();
        })
        .catch(() => {
          this.loading = false;
        });
      }
      
    },
    onAmountChange() {
      this.getRePayPlan();
    },
    // 重置按钮倒计时
    countDown() {
      this.timer = setInterval(() => {
        this.sendBtnTxt = `${this.conter}秒`;
        this.conter--;
        if (this.conter < 0) {
          this.reset();
        }
      }, 1000);
    },
    // 恢复验证码按钮 重置计时器
    reset() {
      this.canSendSms = true;
      this.sendBtnTxt = "发送验证码";
      if (this.timer) {
        clearInterval(this.timer);
        this.conter = 10;
        this.timer = null;
      }
    },
  },
  computed: {
    ...mapGetters(["token", "accountStatus",'name']),
  },
  created(){
    this.loan_form.holder = this.name 
  }
};
</script>

<style lang="scss" scoped>
.el-container {
  max-width: 1140px;
  margin: 0px auto;
  height: 100%;

  .el-header {
    padding: 0px;
    background-color: #b3c0d1;
    color: #333;
    text-align: center;
    width: 100%;
    height: auto !important;
  }

  .loan-main {
    height: 100%;
    padding: 0px !important;
    background-color: #ffd101;
  }

  .el-dropdown-link {
    cursor: pointer;
    color: #409eff;
  }
  .el-icon-arrow-down {
    font-size: 12px;
  }

  .body-box {
    // background-color: #ffd101;
    padding: 60px 100px;
    // height: 100%;
    display: flex;
    justify-content: space-between;

    .title {
      text-align: center;
      margin-bottom: 20px;
    }

    .loan-box {
      width: 400px;
      background-color: #e9eef3;
      padding: 20px;
      // max-height: 600px;
      height: 100%;
    }

    .bg-img {
      max-width: 100%;
      max-height: 100%;
    }

    .sort-input {
      width: 98px;
      margin-left: 0px;
    }
  }

  .el-form-item {
    .codeBtn {
      margin-left: 10px;
      width: 40%;
    }
  }
}
</style>
```



#### 2.1.5 我要投资

> - 我要投资页面的提交，也是会先验证是否登录，未登录提交会弹出提示，引导到登录页面
>
> ![1641522154256](image\5C1641522154256.png)
>
> 期限选择不能小于12个月，必须点击同意条款才能进行购买，购买成功有成功提示，可用金额不足也有对应提示。
>
> ![1632454385063](image\5C1632454385063.png)
>
> ![1632454400980](image\5C1632454400980.png)
>
> ![1632454414070](image\5C1632454414070.png)

---

- 先创建组件，views下创建invest文件夹，下面创建index.vue

![1635240510955](image\5C1635240510955.png)

- 配置路由

  > src-router-index.js

  ![1635240826986](image\5C1635240826986.png)

---

- 编写页面

  先添加页面请求的API和方法

  ![1641522846613](image\5C1641522846613.png)

  ```javascript
  // 获取账号信息
  export function getAccountInfo() {
    return request({
      url: '/account/funds',
      method: 'get',
    })
  }
  ```

  ![1641522967426](image\5C1641522967426.png)

  ```javascript
  // 获取产品列表
  export function getProductList() {
    return request({
      url: '/product/proList',
      method: 'get'
    })
  }
  
  //  获取产品利率
  export function getProductRate(data) {
    return request({
      url: '/product/proRateList',
      method: 'get',
      params: {
        proId: data
      }
    })
  }
  
  // 购买理财产品
  export function buyProduct(data) {
    return request({
      url: '/transaction/invest',
      method: 'post',
      data: data
    })
  }
  ```

  ![1641523194391](image\5C1641523194391.png)

  ![1641523254780](image\5C1641523254780.png)

  ```javascript
  getAccountInfo({ commit } ) {
      return new Promise(resolve => {
        getAccountInfo().then((response) => {
          commit('SET_ACCOUNTINFO', response.data)
          resolve()
        }).catch(error => {
          reject(error)
        })
      })
    },
  ```


![1641525220973](image\5C1641525220973.png)

```javascript

```

![1641523927306](image\5C1641523927306.png)

```javascript
    getProductList({ commit }, data) {
        return new Promise(resolve => {
            getProductList(data).then((response) => {
                resolve(response.data.data)
                commit('SET_PRODUCTLIST', response.data.data)
            }).catch(error => {
                reject(error)
            })
        })
    },

    getProductRate({ commit }, data) {
        return new Promise(resolve => {
            getProductRate(data).then((response) => {
                resolve(response.data.data)

            }).catch(error => {
                reject(error)
            })
        })
    },


    buyProduct({ commit }, data) {
        return new Promise(resolve => {
            buyProduct(data).then((response) => {
                resolve(response.data.data)
            }).catch(error => {
                reject(error)
            })
        })
    },
```

组件内容

```vue
<template>
  <el-container>
    <el-header>
      <HearderBar curIndex="3"></HearderBar>
    </el-header>
    <el-main>
      <div class="body-box">
        <div class="invest-box">
          <div class="invest-container">
            <el-card class="box-card">
              <!--  -->
              <div slot="header" class="card-title">
                <span>理财购买</span>
              </div>
              <div class="body-box">
                <div class="home-page">
                  <!-- 资产展示容器 -->
                  <div class="assets">
                    <!-- 资产分类项 -->
                    <div
                      class="asset-item"
                      v-for="(item, index) in productList"
                      :key="index"
                      :class="{ selectedStyle: planIndex == index }"
                      disabled="false"
                      @click="selectPlan(index)"
                    >
                      <div class="type_title">{{ item.productName }}</div>
                      <el-image
                        :src="require(`@/assets/invest/${index + 1}.jpg`)"
                      ></el-image>
                      <div>{{ planList[index] }}</div>

                      <div class="btn-box">
                        <el-button type="primary" size="small" class="hidden"
                          >我要购买</el-button
                        >
                      </div>
                    </div>
                  </div>
                  <!-- 投资计划容器 -->
                  <div class="plan-box">
                    <el-card class="card-plan">
                      <div class="investBox">
                        <el-table
                          :data="tableData"
                          border
                          :show-header="false"
                          style="width: 100%"
                        >
                          <el-table-column prop="title" min-width="1">
                          </el-table-column>
                          <el-table-column min-width="5">
                            <template slot-scope="scope">
                              <div
                                v-if="scope.$index === 0"
                                class="invest-money-box"
                              >
                                <el-input-number
                                  v-model="amount"
                                  :step="100"
                                  placeholder="100元的整数倍"
                                  class="moneyInput"
                                  @change="amountChange"
                                ></el-input-number
                                >元
                              </div>
                              <div v-else-if="scope.$index === 1">
                                <div class="block">
                                  <el-slider
                                    v-model="month"
                                    :step="6"
                                    :max="maxMounth"
                                    @change="monthChange"
                                  >
                                  </el-slider>
                                </div>
                              </div>
                              <div v-else-if="scope.$index === 2">
                                {{ yearRate }}
                              </div>
                              <div v-else-if="scope.$index === 3">
                                {{ monthRate }}
                              </div>
                              <!-- <div v-else-if="scope.$index === 4">
                                {{ monthRateGet }}
                              </div> -->
                              <div v-else-if="scope.$index === 4">
                                您选择了{{ curProName }},加入的本金为{{
                                  amount
                                }}元,投资期限为{{ month }}个月,预期年化收益为{{
                                  yearRate
                                }}%，系统将每月返还利息{{
                                  monthRate
                                }}元至您的账户，请确认购买。
                              </div>
                              <div v-else-if="scope.$index === 5">
                                <el-button
                                  type="success"
                                  @click="loginVerify"
                                  round
                                  :disabled="!checked"
                                  >购买</el-button
                                >
                                <el-checkbox class="confirm" v-model="checked"
                                  >我同意</el-checkbox
                                >
                                <el-button
                                  @click="drawer = true"
                                  type="text"
                                  style="margin-left: 16px"
                                >
                                  出借条款
                                </el-button>
                              </div>
                            </template>
                          </el-table-column>
                        </el-table>
                      </div>
                    </el-card>
                  </div>
                  <el-drawer title="出借条款" :visible.sync="drawer">
                    <span
                      >尊敬的客户：为了维护您的权益，请在签署本协议前，仔细阅读本协议各条款（特别是黑体字条款），充分了解银行理财业务的运作规则、协议双方的权利、
                      义务和责任。如有疑问，可向银行理财产品发售机构咨询。
                      一、定义。本协议项下的理财产品：是指乙方 （天津银行）
                      接受甲方 （客户）
                      的理财申请，代理甲方将其人民币理财资金投资于理财产品说明书中指定
                      的投资计划。乙方在产品实际到期日，按投资收益情况和协议约定向甲方支付人民币收益的产品。理财资金账户：指客户在代理机构开立的活期账户。理财产品
                      说明书：指对理财产品投资范围、投资资产种类和各投资资产种类的投资比例，并确保在理财产品存续期间按照销售文件的约定。客户权益须知：指客户购买理
                      财产品的流程、客户风险承受能力评估流程、信息披露的方式、渠道和频率、客户投诉的方式和程序的相关约定。其他事项以理财产品说明书为准。
                      二、协议的构成和效力。投资人所认购／申购产品的理财协议书、产品说明书、风险揭示书及客户权益须知、个人客户投资（投保）风险承受能力评估问卷
                      等有关法律文件共同构成一份完整且不可分割的理财合同。
                      三、双方的声明和保证。天津银行将理财客户划分为保守型、谨慎型、稳健型、进取型、激进型客户，并在理财产品销售文件中标明所适合的客户类别。投
                      资人保证自己为符合理财产品销售适用性原则的合格投资者，能够自行识别、判断和承担理财产品的相关风险；不存在法律法规、有权机关或主管机关禁止或限
                      制购买理财产品的各种情形，其购买理财产品的行为亦未违反其公司章程或其他文件的任何限制性规定，并熟悉理财产品类型特征及不同销售渠道的相关规定。
                      天津银行保证自身具有开办理财业务的经营资质，保证以诚实信用、勤勉谨慎的原则管理和运用理财资金。
                      甲、乙双方对本协议及其条款负有保密义务，除法律、法规另有规定或监管机构另有要求外，未经一方书面许可，不得向任何组织、个人提供或泄露与对方
                      有关的业务资料及信息。
                      四、理财产品的认购。天津银行根据理财产品特点和管理需要，对特定理财产品开放认购或预约。投资人预约成功后可优先于未预约客户认购已预约的额度，
                      但投资人办理预约应遵守相关规定。
                      天津银行于产品说明书列明的募集开始日起至募集结束日止受理投资人的认购，并根据法律法规变化、市场状况、资金募集情况或在出现其他可能影响理财
                      产品正常运作或投资目标实现的情形时，做出暂停／恢复募集、延长募集期限、提前结束募集宣布产品成立、或者终止募集宣布募集失败的决定，并通过约定信
                      息披露途径予以通知。
                    </span>
                  </el-drawer>
                </div>
              </div>
            </el-card>
          </div>
        </div>
      </div>
      <el-dialog title="确认购买" :visible.sync="makeSureVisible" width="30%">
        <el-card class="box-card">
          <div>
            <el-table
              :data="makeSureTable"
              style="width: 100%"
              border
              :show-header="false"
            >
              <el-table-column prop="title" label="日期" width="150">
              </el-table-column>
              <el-table-column prop="content" label="姓名"> </el-table-column>
            </el-table>
            <!-- <div>购买金额：{{amount}} | 购买期数：{{month}} | </div>
            <div>每月收益：{{monthRate}} | 到期总收益：{{month * monthRate}}</div>
            <div>可用余额：{{amount}}</div>
            <div>可用抵扣金额：{{amount}}</div> -->
          </div>
        </el-card>
        <span slot="footer" class="dialog-footer">
          <el-button @click="makeSureVisible = false">取 消</el-button>
          <el-button type="primary" @click="onBuy">确认购买</el-button>
        </span>
      </el-dialog>
    </el-main>
  </el-container>
</template>

<script>
import HearderBar from "@/components/HeaderBar/index"; //顶栏组件
import InvestBox from "@/views/invest/index"; //顶栏组件
import { mapGetters, mapActions } from "vuex";
export default {
  name: "Invest",
  components: {
    HearderBar,
    InvestBox,
  },
  data() {
    return {
      makeSureVisible: false,
      invite_url: "",
      planList: ["整存零取 存本取息", "整存整取 利上滚利", "零存整取 积少成多"],
      month: 12,
      yearRate: 12,
      monthRate: 0, // 预期收益
      monthRateGet: 0, // 提取金额
      planInstruction: "",
      maxMounth: 36,
      drawer: false,
      checked: false,
      amount: 1000,
      planIndex: 0,
      curProRateList: {},
      curProduct: "",
      curUseDiscount: 0,
      tableData: [
        {
          title: "投资金额",
        },
        {
          title: "请选择期限(月)",
        },
        {
          title: "预计年化收益",
        },
        {
          title: "每月赢取利息",
        },

        {
          title: "配置结果",
        },
        {
          title: "",
        },
      ],
      makeSureTable: [
        {
          title: "购买产品",
          content: "",
        },
        {
          title: "购买金额",
          content: "",
        },
        {
          title: "购买期数",
          content: "",
        },
        {
          title: "预期收益",
          content: "",
        },
        {
          title: "账户可用金额",
          content: "",
        },
        {
          title: "可抵扣金额",
          content: "",
        },
      ],
    };
  },
  computed: {
    ...mapGetters(["productList", "token", "accountInfo"]),
    curProName() {
      this.curProductName =
        this.productList.length > 0
          ? this.productList[this.planIndex].productName
          : "";
      return this.curProductName;
    },
    showDiscount() {
      return this.accountInfo.discount >= 50 ? 50 : 0;
    },
  },
  methods: {
    ...mapActions({
      getAcctInfo: "user/getAccountInfo",
      getList: "invest/getProductRate",
      buyPro: "invest/buyProduct",
      getProList: "invest/getProductList",
    }),
    amountChange() {
      this.calculat_income();
    },
    onBuy() {
      if (this.accountInfo.balance < this.amount - this.showDiscount) {
          this.$message.error("账户可用余额不足");
          return
        }
      var data = {
        productId: 2,
        pAmount: this.amount,
        period: this.month,
        pRate: this.yearRate,
        monthRate: this.monthRate,
        monthRateGet: this.monthRateGet,
        discount:this.showDiscount
      };
      this.buyPro(data)
        .then((data) => {
          this.getAcctInfo();
          this.$message({
            message: "购买成功",
            type: "success",
          });
          this.makeSureVisible = false
          // 2秒后重定向到 
              setTimeout(() => {
                this.$router.push("/invest/myInvest");
              }, 1500);
        })
        .catch(() => {});
    },
    monthChange(val) {
      if (val >= 12) {
        this.yearRate = this.curProRateList[val].incomeRate;
        this.calculat_income();
      }
    },
    calculat_income() {
      var temNum = (this.yearRate / 100 / 12) * 1000000;
      var _index = String(temNum).indexOf(".");
      if (_index > 0) {
        temNum = String(temNum).substring(0, _index) / 1000000;
      } else {
        temNum = temNum / 1000000;
      }
      console.log("1111111111");
      this.monthRate = Math.floor(this.amount * temNum * 100) / 100;
      this.monthRateGet = this.monthRate;
    },
    selectPlan(index) {
      console.log("this.monthRate", this.monthRate);
      this.planIndex = index;

      // this.curProductName = this.productList[index].productName
      // console.log('this.curProductName',this.curProductName)
      // this.makeSureTable[0].content = this.curProName
      // this.$forceUpdate()
    },
    readDealInfo() {
      this.makeSureTable[0].content = this.curProName;
      this.makeSureTable[1].content = `${this.amount}` + " 元";
      this.makeSureTable[2].content = this.month;
      this.makeSureTable[3].content =
        `${this.month}` +
        " * " +
        `${this.monthRate}` +
        " = " +
        `${Math.floor(this.month * this.monthRate * 100) / 100}` +
        " 元";
      this.makeSureTable[4].content = this.accountInfo.balance;
      this.makeSureTable[5].content = `${this.showDiscount}` + "元"
    },
    // 登录 验证
    loginVerify() {
      if (!this.token) {
        this.$confirm("请先登录", "提示", {
          confirmButtonText: "去登录",
          cancelButtonText: "取消",
          type: "warning",
        }).then(() => {
          this.$router.push({ path: "/login" });
        });
      } else if (this.month < 12) {
        this.$message.error("最小期限不能少于12个月");
      } else if (this.amount < 1000) {
        this.$message.error("最小投资金额不能低于1000");
      } else {
        
        this.readDealInfo();
        this.makeSureVisible = true;
      }
    },
  },
  created() {
    if (this.$route.query.planIndex) {
      this.planIndex = this.$route.query.planIndex;
    }
    this.selectPlan(this.planIndex);
    this.getList(3)
      .then((data) => {
        if (data) {
          this.curProRateList = data;
          this.yearRate = this.curProRateList[this.month].incomeRate;
          this.calculat_income();
        }
      })
      .catch(() => {});
    if (!this.productList.length) {
      this.getProList();
    }
  },
};
</script>

<style lang="scss" scoped>
.el-container {
  max-width: 1140px;
  margin: 0px auto;
  height: 100%;

  .el-header {
    padding: 0px;
    background-color: #b3c0d1;
    color: #333;
    text-align: center;
    width: 100%;
    height: auto !important;
  }

  .el-main {
    height: 100%;
    padding: 0px !important;
  }

  .body-box {
    height: 100%;
  }

  .invest-box {
    background-color: #ffd101;
    height: 100%;
    padding: 20px 30px;

    .invest-container {
      // margin: 50px auto;
      // padding: 50px auto;
      max-width: 1200px;

      .selectedStyle {
        border: rgb(146, 146, 146) 1px dashed;
        box-sizing: border-box;
      }

      .hidden {
        visibility: hidden;
      }

      .type_title {
        margin-top: 15px;
        font-size: 20px;
        color: #409eff;
      }
      .assets {
        display: flex;
        justify-content: space-around;
        .el-divider {
          height: auto;
        }
        .asset-item {
          width: 155px;
          // height: 260px;
          text-align: center;
          .el-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 6%;
            margin-bottom: 10px;
          }
          .money {
            font-size: 20px;
            color: #3ca0f3;
            margin: 5px 0;
          }
          .el-button {
            margin: 0 5px;
          }
        }
      }

      .confirm {
        margin: 0 10px;
      }

      .invest-money-box {
        display: flex;
        align-items: center;
      }

      .moneyInput {
        max-width: 150px;
      }

      .plan-box {
        display: flex;
        justify-content: center;

        .card-plan {
          margin-top: 15px;
          width: 100%;
        }
      }

      .card-title {
        font-size: 22px;
        color: #409eff;
      }

      .create-btn {
        width: 350px;
      }

      .el-alert {
        margin-bottom: 15px;
      }
    }
  }
}
</style>
```



#### 2.1.6 退出登录

- 修改退出登录请求的api

  ![1626170206701](image\5C1626170206701.png)

  ```javascript
  // 退出登录
  export function logout() {
    return request({
      url: '/user/loginOut',
      method: 'post'
    })
  }
  ```

  ![1635239506380](image\5C1635239506380.png)

  ```javascript
    // user logout
    logout({ commit, state }) {
      return new Promise((resolve, reject) => {
        logout(state.token).then(() => {
          removeToken() // must remove  token  first
          resetRouter()
          commit('RESET_STATE')
          resolve()
        }).catch(error => {
          reject(error)
        })
      })
    },
  ```

- 修改个人主页，右上角的下拉菜单

  ![1626170722170](image\5C1626170722170.png)

  ```html
  <div class="avatar-wrapper">
            <i class="el-icon-user-solid"></i>
          </div>
          <el-dropdown-menu slot="dropdown" class="user-dropdown">
            <router-link to="/">
              <el-dropdown-item>
                个人中心
              </el-dropdown-item>
            </router-link>
            <el-dropdown-item divided @click.native="logout">
              <span style="display:block;">退出</span>
            </el-dropdown-item>
  ```

  样式

  ![1626170935805](image\5C1626170935805.png)

  ```css
  .el-icon-user-solid {
            font-size: 24px;
          }
  ```

---

### 3.个人中心

#### 3.1 个人首页

登录后自动跳转到个人首页

![1626056773660](image\5C1626056773660.png)

个人首页包括上面的用户信息展示(头像，用户名，以及下面的认证状态栏)

认证状态栏包括，手机认证，实名认证，支付密码设置，邮箱认证。已认证为绿色，未认证为灰色。

3.1.1 先修改请求用户信息的api接口地址，对应我们后台提供的api.

![1626058636520](image\5C1626058636520.png)

3.1.2 下面我们来写，个人首页

> src-views-dashboard-index.vue

```vue
<template>
  <div class="dashboard-container">
    <!-- 用户信息卡片 -->
    <el-card class="user-card">
      <div class="head">
        <!-- 头像 -->
        <div class="avatar">
          <div class="block">
            <el-avatar :size="50" :src="circleUrl"></el-avatar>
          </div>
        </div>
        <!-- 名字 -->
        <span>{{ name }}</span>
      </div>
      <el-divider></el-divider>
      <!-- 用户状态容器 根据用户相关属性是否认证 显示不同颜色 -->
      <div class="user-status">
        <span :class="{ 'status-succes': status.phoneStatus }"
          ><i class="el-icon-mobile-phone"></i
        ></span>
        <el-divider direction="vertical"></el-divider>
        <span :class="{ 'status-succes': status.realNameAuth }"
          ><i class="el-icon-user"></i
        ></span>
        <el-divider direction="vertical"></el-divider>
        <span :class="{ 'status-succes': status.payPwdStatus }"
          ><i class="el-icon-lock"></i
        ></span>
        <el-divider direction="vertical"></el-divider>
        <span :class="{ 'status-succes': 0 }"
          ><i class="el-icon-message"></i
        ></span>
      </div>
    </el-card>
    <!-- 主题容器 -->
    <el-card class="home-page">
      <!-- 资产展示容器 -->
      <div class="assets">
        <!-- 资产分类项 -->
        <div class="asset-item">
          <el-image :src="require('@/assets/dashboard/1.png')"></el-image>
          <div>可用余额</div>
          <div class="money">{{ accountInfo.total }}元</div>
          <div class="btn-box">
            <router-link :to="{ path: '/assetManage/recharge' }">
              <el-button type="primary" size="small">充值</el-button>
            </router-link>
            <router-link :to="{ path: '/assetManage/extract' }">
              <el-button type="warning" size="small">提现</el-button>
            </router-link>
          </div>
        </div>
        <div class="asset-item">
          <el-image :src="require('@/assets/dashboard/2.png')"></el-image>
          <div>资产总额</div>
          <div class="money">{{ accountInfo.balance }}元</div>
          <div class="btn-box">
            <router-link :to="{ path: '/assetManage/recharge' }">
              <el-button type="primary" size="small">充值</el-button>
            </router-link>
            <router-link :to="{ path: '/assetManage/extract' }">
              <el-button type="warning" size="small">提现</el-button>
            </router-link>
          </div>
        </div>
        <div class="asset-item">
          <el-image :src="require('@/assets/dashboard/3.png')"></el-image>
          <div>累积收益</div>
          <div class="money">{{ accountInfo.profit }}元</div>
          <div class="btn-box">
            <router-link :to="{ path: '/assetManage/recharge' }">
              <el-button type="primary" size="small">充值</el-button>
            </router-link>
            <router-link :to="{ path: '/assetManage/extract' }">
              <el-button type="warning" size="small">提现</el-button>
            </router-link>
          </div>
        </div>
      </div>
      <!-- 投资计划容器 -->
      <div class="plan-box">
        <el-card class="card-plan">
          <div slot="header" class="clearfix">
            <span>投资计划</span>
          </div>
          <div v-for="o in 3" :key="o" class="text item">
            <div class="plan-item">
              <div class="plan-content">
                <div class="plan-title">
                  <h4>月取计划</h4>
                </div>
                <div class="plan-data">
                  <div class="plan-date">
                    交易期限: <br />
                    年华收益率:
                  </div>
                  <div class="plan-income">12-36个月<br />12%</div>
                </div>
              </div>
              <div class="plan-btn">
                <router-link :to="{ path: '/form/index' }">
                  <el-button type="success">投资</el-button>
                </router-link>
              </div>
            </div>
          </div>
        </el-card>
      </div>
    </el-card>
  </div>
</template>

<script>
import { mapGetters } from "vuex";
export default {
  name: "Dashboard",
  data() {
    return {
      circleUrl:
        "https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",
      src: "https://cube.elemecdn.com/6/94/4d3ea53c084bad6931a56d5158a48jpeg.jpeg",
      status: {
        phoneStatus: 0,
        realNameAuth: 0,
        payPwdStatus: 0
      },
    };
  },
  mounted() {},
  methods: {
    setStatus(){
      for (var Key in this.status){
      this.status[Key] = this.accountStatus[Key]
    }
    }
  },
  computed: {
    ...mapGetters(["name", "accountStatus", "accountInfo"]),
  },
  created(){
    this.setStatus()
  }
};
</script>

<style lang="scss" scoped>
.dashboard {
  &-container {
    // margin: 30px;
    margin: 50px auto;
    max-width: 1000px;
  }
  &-text {
    font-size: 30px;
    line-height: 46px;
  }
}

.user-card {
  display: flex;
  // max-width:330px;
  width: auto;
}

.head {
  display: flex;
  align-items: center;
  span {
    margin-left: 10px;
  }
}

.user-status {
  i {
    font-size: 20px;
  }
}

.home-page {
  margin-top: 10px;
  .assets {
    display: flex;
    justify-content: space-around;
    .el-divider {
      height: auto;
    }
    .asset-item {
      text-align: center;
      .el-image {
        max-width: 150px;
        max-height: 150px;
        border-radius: 6%;
        margin-bottom: 10px;
      }
      .money {
        font-size: 20px;
        color: #3ca0f3;
        margin: 5px 0;
      }
      .el-button {
        margin: 0 5px;
      }
    }
  }
  .card-plan {
    margin-top: 15px;
    width: 100%;
  }
}

.status-succes {
  color: #67c23a;
}

.plan-box {
  display: flex;
  justify-content: center;
}

.plan-item {
  background-color: #f0f0f0;
  border-radius: 5px;
  margin-bottom: 25px;
  display: flex;
  justify-content: space-between;
  .plan-content {
    .plan-title {
      padding: 0 25px;
      box-sizing: border-box;
      background-color: #0fb475;
      border-radius: 5px;
      color: white;
    }
    display: flex;
    justify-content: space-between;
    .plan-data {
      display: flex;
      align-items: center;
      margin-left: 15px;
      line-height: 150%;
      color: #616161;
      .plan-date {
        text-align: right;
        margin-right: 8px;
      }
    }
  }

  .plan-btn {
    display: flex;
    align-items: center;
    padding-right: 15px;
  }
}
</style>


```

在vuex的state里面添加2个属性来保存用户的账户信息和账户状态，mutaition新增2个方法来设置这2个属性。

![1626062029254](image\5C1626062029254.png)

```javascript
accountStatus:null,
    accountInfo:{}
    
SET_ACCOUNTSTATUS: (state, status) => {
    state.accountStatus = status
  },
  SET_ACCOUNTINFO: (state, status) => {
    state.accountInfo = status
  }
```

然后在请求用户信息的返回中，调用设置用户信息和状态的方法，为其赋值。

![1626062176807](image\5C1626062176807.png)

```javascript
commit('SET_ACCOUNTSTATUS', data.userInfoData)
        commit('SET_ACCOUNTINFO', data.accountInfo)
```

然后在getters里面添加这2个对象

![1626062491867](image\5C1626062491867.png)

```
accountStatus:state => state.user.accountStatus,
  accountInfo:state => state.user.accountInfo
```

接下来我们刷新，登录进来的页面，可以看到，页面已经正常呈现，并获取到了用户的信息，认证状态及账户信息

![1626062738560](image\5C1626062738560.png)

#### 3.2 左侧菜单栏

我们将左侧菜单栏编辑一下，变成我们项目需求的样子。（里面具体对应的模块，后面再改）

![1626068910419](image\5C1626068910419.png)

```javascript
{
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '个人主页', icon: 'el-icon-user-solid' }
    }]
  },

  {
    path: '/example',
    component: Layout,
    redirect: '/example/table',
    name: 'Example',
    meta: { title: '资产管理', icon: 'el-icon-s-finance' },
    children: [
      {
        path: 'assetManage',
        name: 'AssetManage',
        component: () => import('@/views/table/index'),
        meta: { title: '资产统计'}
      },
      {
        path: 'recharge',
        name: 'recharge',
        component: () => import('@/views/table/index'),
        meta: { title: ' 充值'}
      },
      {
        path: 'extract',
        name: 'extract',
        component: () => import('@/views/table/index'),
        meta: { title: ' 提现'}
      }
    ]
  },

  {
    path: '/form',
    component: Layout,
    children: [
      {
        path: 'index',
        name: 'Form',
        component: () => import('@/views/form/index'),
        meta: { title: '投资管理', icon: 'el-icon-s-order' }
      }
    ]
  },

  {
    path: '/award',
    component: Layout,
    children: [
      {
        path: 'index',
        name: 'award',
        component: () => import('@/views/form/index'),
        meta: { title: '奖励管理', icon: 'el-icon-s-claim' }
      }
    ]
  },

  {
    path: '/nested',
    component: Layout,
    redirect: '/nested/menu1',
    name: 'Nested',
    meta: {
      title: '消息管理',
      icon: 'el-icon-message-solid'
    },
    children: [
      {
        path: 'menu1',
        component: () => import('@/views/nested/menu1/index'), // Parent router-view
        name: 'Menu1',
        meta: { title: 'Menu1' },
        children: [
          {
            path: 'menu1-1',
            component: () => import('@/views/nested/menu1/menu1-1'),
            name: 'Menu1-1',
            meta: { title: 'Menu1-1' }
          },
          {
            path: 'menu1-2',
            component: () => import('@/views/nested/menu1/menu1-2'),
            name: 'Menu1-2',
            meta: { title: 'Menu1-2' },
            children: [
              {
                path: 'menu1-2-1',
                component: () => import('@/views/nested/menu1/menu1-2/menu1-2-1'),
                name: 'Menu1-2-1',
                meta: { title: 'Menu1-2-1' }
              },
              {
                path: 'menu1-2-2',
                component: () => import('@/views/nested/menu1/menu1-2/menu1-2-2'),
                name: 'Menu1-2-2',
                meta: { title: 'Menu1-2-2' }
              }
            ]
          },
          {
            path: 'menu1-3',
            component: () => import('@/views/nested/menu1/menu1-3'),
            name: 'Menu1-3',
            meta: { title: 'Menu1-3' }
          }
        ]
      },
      {
        path: 'menu2',
        component: () => import('@/views/nested/menu2/index'),
        name: 'Menu2',
        meta: { title: 'menu2' }
      }
    ]
  },

  {
    path: '/account',
    name: 'accountSettings',
    component: Layout,
    redirect: '/account/safe',
    meta: { title: '账号设置', icon: 'el-icon-s-finance' },
    children: [
      {
        path: 'safe',
        name: 'safeSetting',
        component: () => import('@/views/table/index'),
        meta: { title: '安全设置'}
      },
      {
        path: 'card',
        name: 'card',
        component: () => import('@/views/table/index'),
        meta: { title: '银行卡信息'}
      }
    ]
  },

  // 404 page must be placed at the end !!!
  { path: '*', redirect: '/404', hidden: true }
```

#### 3.3 账号设置

##### 3.3.1 安全设置

> 安全设置显示用户的相关状态信息，并根据是否认证显示不同的标识，并可以进行不同的操作。

![1626071103767](image\5C1626071103767.png)

---

先创建 安全设置组件，views下创建account文件夹，下面创建safe.vue

![1626069350983](image\5C1626069350983.png)

配置路由

将上面路由中安全设置对应的组件 修改为 

![1626069510196](image\5C1626069510196.png)

在safe.vue中先写入一个空白的template，放入一个div,保存

我们点击左侧菜单栏账号设置下面的安全设置，成功跳转到页面

![1626070139148](image\5C1626070139148.png)

---

下面编写页面

- 先添加组件里要用到的，请求实名认证和设置支付密码的方法

![1626072485986](image\5C1626072485986.png)

```javascript
// 设置支付密码
export function setPayPwd(data) {
  return request({
    url: '/user/payPwd',
    method: 'post',
    data: data
  })
}

// 实名认证
export function realNameAuth(data) {
  return request({
    url: '/user/realName',
    method: 'post',
    data: data
  })
}
```

action里面导入刚刚创建的api请求并使用。

![1626074929336](image\5C1626074265892.png)

```
setPayPwd, realNameAuth

SET_PAYPWD: (state, status) => {
    state.accountStatus.payPwdStatus = 1
  },
  SET_REALNAME: (state, status) => {
    state.accountStatus.realNameAuth = 1
  },
```

![1626075112243](image\5C1626074330365.png)

```
setPayPwd({commit}, data){
    return new Promise(resolve => {
      setPayPwd(data).then((response) => {
        console.log('设置支付密码成功')
        commit('SET_PAYPWD')
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },

  realNameAuth({commit}, data){
    return new Promise(resolve => {
      realNameAuth(data).then((response) => {
        console.log('实名认证成功')
        commit('SET_REALNAME')
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },

```



---

- 下面是组件里面的内容

```vue
<template>
  <div class="safe-container">
    <!-- 安全设置 卡片容器 -->
    <el-card class="box-card">
      <div class="setting-box">
        <!-- 表单组件 -->
        <el-table
          :data="tableData"
          style="width: 100%"
        >
          <el-table-column prop="safeType" label="安全设置" width="80">
          </el-table-column>
          <el-table-column prop="status" width="80">
            <template slot-scope="scope">
              <!-- 根据这行的值来设置 是否应用样式 -->
              <div :class="{ statusSuccess: scope.row.status }">
                <i class="el-icon-success"></i>
              </div>
            </template>
          </el-table-column>
          <!-- formatter 格式化内容 -->
          <el-table-column
            prop="value"
            :formatter="stateFormat"
            max-width="480"
          >
          </el-table-column>
          <el-table-column width="120">
            <template slot-scope="scopeBtn">
              <!-- 根据不同的安全类型和值 设置不同的按钮 -->
              <el-button
                type="text"
                v-if="checkStatus(scopeBtn.row) == '认证成功'"
              >
                认证成功
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '去认证'"
                @click="authAccount"
              >
                去认证
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '更换手机号'"
                @click="changePhone"
              >
                更换手机号
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '修改'"
                @click="changeLoginPwd"
              >
                修改
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '重置'"
                @click="changePayPwd"
              >
                重置
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '去设置'"
                @click="setPayPwd"
              >
                去设置
              </el-button>
            </template>
          </el-table-column>
        </el-table>
      </div>
    </el-card>
    <!-- 设置支付密码的对话框 -->
    <el-dialog
      title="设置支付密码"
      :visible.sync="payPwdDialogVisible"
      width="30%"
      center
    >
      <el-form
        ref="ruleForm"
        :rules="rules"
        :model="ruleForm"
        label-width="80px"
      >
        <el-form-item label="支付密码" prop="password">
          <el-input
            type="password"
            v-model="ruleForm.password"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="确认密码" prop="checkPass">
          <el-input
            type="password"
            v-model="ruleForm.checkPass"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="onSubmit('ruleForm')"
            >确认</el-button
          >
          <el-button @click="onCancel('ruleForm')">取消</el-button>
        </el-form-item>
      </el-form>
    </el-dialog>
    <!-- 实名认证的对话框 -->
    <el-dialog
      title="实名认证"
      :visible.sync="realNameDialogVisible"
      width="30%"
      center
    >
      <el-form
        ref="realNameForm"
        :rules="realNameRules"
        :model="realNameForm"
        label-width="80px"
      >
        <el-form-item label="姓名" label-width="100px" prop="realName">
          <el-input
            maxLength="10"
            v-model="realNameForm.realName"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="身份证号码" label-width="100px" prop="idNum">
          <el-input v-model="realNameForm.idNum" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="onRealNameSubmit('realNameForm')"
            >确认</el-button
          >
          <el-button @click="onCancel('realNameForm')">取消</el-button>
        </el-form-item>
      </el-form>
    </el-dialog>
  </div>
</template>

<script>
import { mapGetters, mapMutations, mapActions } from "vuex";
export default {
  methods: {
    // 实名验证表单提交
    onRealNameSubmit(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          console.log("通过验证");
          const data = {
            realName: this.realNameForm.realName,
            idNum: this.realNameForm.idNum,
          };
          // 调用 请求实名认证api的 方法
          this.$store
            .dispatch("user/realNameAuth", data)
            .then(() => {
              this.$message({
                message: "认证成功",
                type: "success",
              });
              this.onCancel(formName);
              this.setStatus();
            })
            .catch(() => {});
        } else {
          console.log("未通过验证");
        }
      });
    },
    // 设置支付密码表单提交
    onSubmit(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          console.log("通过验证");
          const data = { pwd: this.ruleForm.password };
          // 调用 请求设置支付密码api的 方法
          this.$store
            .dispatch("user/setPayPwd", data)
            .then(() => {
              this.$message({
                message: "设置成功",
                type: "success",
              });
              this.onCancel(formName);
              this.setStatus();
            })
            .catch(() => {});
        } else {
          console.log("未通过验证");
        }
      });
    },
    // 点击取消 隐藏窗口 重置表单
    onCancel(formName) {
      console.log("隐藏窗口");
      this.$refs[formName].resetFields();
      this.payPwdDialogVisible = false;
      this.realNameDialogVisible = false;
    },
    setStatus() {
      var cont = 0;
      for (var key in this.accountStatus) {
        this.tableData[cont].status = this.accountStatus[key];
        this.tableData[cont].value = this.accountStatus[key];
        cont++;
      }
    },
    stateFormat(row, column) {
      if (row.safeType === "用户名") {
        return row.value;
      } else if (row.safeType === "实名认证") {
        return row.status ? "已认证" : "未认证";
      } else if (row.safeType === "手机认证") {
        return row.status ? row.value : "未设置";
      } else if (row.safeType === "登录密码" || row.safeType === "支付密码") {
        return row.status ? "已设置" : "未设置";
      }
    },
    checkStatus(row) {
      if (row.safeType === "手机认证") {
        return "更换手机号";
      } else if (row.safeType === "实名认证") {
        if (row.value) {
          return "认证成功";
        } else {
          return "去认证";
        }
      } else if (row.safeType === "登录密码") {
        return "修改";
      } else if (row.safeType === "支付密码") {
        if (row.value) {
          return "重置";
        } else {
          return "去设置";
        }
      } else {
      }
    },
    authAccount() {
      console.log("认证账户");
      this.realNameDialogVisible = true;
    },
    changePhone() {
      console.log("修改手机");
    },
    changeLoginPwd() {
      console.log("修改登录密码");
    },
    changePayPwd() {
      console.log("修改支付密码");
    },
    setPayPwd() {
      console.log("设置支付密码");
      this.payPwdDialogVisible = true;
    },
  },
  data() {
    var validatePass = (rule, value, callback) => {
      if (value === "") {
        callback(new Error("请输入密码"));
      } else {
        if (this.ruleForm.checkPass !== "") {
          this.$refs.ruleForm.validateField("checkPass");
        }
        callback();
      }
    };
    var validatePass2 = (rule, value, callback) => {
      if (value === "") {
        callback(new Error("请再次输入密码"));
      } else if (value !== this.ruleForm.password) {
        callback(new Error("两次输入密码不一致!"));
      } else {
        callback();
      }
    };

    var validateName = (rule, value, callback) => {
      var reg = new RegExp("[\\u4E00-\\u9FFF]+$", "g");
      if (!reg.test(value)) {
        callback(new Error("不是纯中文字符"));
      } else {
        callback();
      }
    };

    var validateIdNum = (rule, value, callback) => {
      var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
      if (!reg.test(value)) {
        callback(new Error("身份证输入不合法"));
      } else {
        callback();
      }
    };
    return {
      payPwdDialogVisible: false,
      realNameDialogVisible: false,
      rules: {
        password: [
          { validator: validatePass, required: true, trigger: "blur" },
          {
            min: 6,
            max: 18,
            trigger: "blur",
            message: "密码6到18位之间",
          },
        ],
        checkPass: [
          { validator: validatePass2, required: true, trigger: "blur" },
        ],
      },
      realNameRules: {
        realName: [
          { validator: validateName, required: true, trigger: "blur" },
        ],
        idNum: [{ validator: validateIdNum, required: true, trigger: "blur" }],
      },
      tableData: [
        {
          safeType: "用户名",
          status: "",
          value: "",
        },
        {
          safeType: "实名认证",
          status: "",
          value: "",
        },
        {
          safeType: "手机认证",
          status: "",
          value: "",
        },
        {
          safeType: "登录密码",
          status: "",
          value: "",
        },
        {
          safeType: "支付密码",
          status: "",
          value: "",
        },
      ],
      ruleForm: {
        password: "",
        checkPass: "",
      },
      realNameForm: {
        realName: "",
        idNum: "",
      },
    };
  },
  computed: {
    ...mapGetters(["accountStatus"]),
  },
  created() {
    this.setStatus();
  },
};
</script>

<style lang="scss" scoped>
.safe-container {
  margin: 50px auto;
  max-width: 1000px;
}

.statusSuccess {
  color: lightgreen;
}

.status-fail {
  font-size: 20px;
  // color: lightgreen;
}

.text {
  font-size: 14px;
}

.item {
  padding: 18px 0;
}

.box-card {
  width: 80%;
  margin: 0px auto;
  .el-icon-success {
    font-size: 20px;
  }
}

</style>
```

- 测试页面

  刷新页面，可以正常显示用户的状态，点击实名认证，输入姓名，身份证号码。确认，认证成功。

  页面上状态发生变化，可操作内容也变化了。

  ![1626075893173](image\5C1626075893173.png)

  ![1626075955508](image\5C1626075955508.png)

  ![1626075984367](image\5C1626075984367.png)

---

##### 3.3.2 银行卡设置

> 管理用户的银行卡，可以添加，删除。点击编辑按钮，银行卡右上角会出现垃圾桶小图标，点击会弹出对话框是否确认删除，点击添加银行卡会弹出添加银行卡的对话框。

![1626076509298](image\5C1626076509298.png)

![1626076636016](image\5C1626076636016.png)

![1626076689625](image\5C1626076689625.png)

---

- 先创建 银行卡设置组件，views下account文件夹，下面创建safe.vue

  ![1626076884956](image\5C1626076884956.png)

  修改之前配置的路由

  > src-router-index.js

  ![1626077177086](image\5C1626077177086.png)

---

- 先添加组件里要用到的，请求 银行卡列表，添加和删除银行卡的方法

  ![1626077791851](image\5C1626077791851.png)

```javascript
export function addBankCard(data) {
  return request({
    url: '/card/card',
    method: 'post',
    data: data
  })
}

export function getBankCard() {
  return request({
    url: '/card/card',
    method: 'get',
  })
}

export function delBankCard(data) {
  return request({
    url: '/card/card',
    method: 'delete',
    data: data
  })
}
```

![1626078273845](image\5C1626078273845.png)

![1626078860778](image\5C1626078860778.png)

- 然后在getters里面添加 bankCardList

  ![1626079946439](image\5C1626079946439.png)

  ```
  
  ```

---

**<u>在写组件内代码前，我们先安装一个 省市区三级联动选择 的插件</u>**

> npm install element-china-area-data -S
>
> 实现效果如下
>
> ![1626080065363](image\5C1626080065363.png)

---

下面是vue文件内代码

```vue
<template>
  <div class="card-container">
    <el-card class="box-card">
      <!-- 卡片标题 -->
      <div slot="header" class="clearfix">
        <span>银行卡设置</span>
        >
      </div>
      <!-- v-if 根据用户是否有银行卡来显示 -->
      <div v-if="bankCardList.length" class="bankCardList">
        <!-- 编辑按钮 -->
        <el-checkbox class="edit-btn" v-model="isEdit">编辑</el-checkbox>
        <div class="card-box">
          <!-- 循环渲染 银行卡 -->
          <div
            v-for="(item, index) in bankCardList"
            :key="index"
            style="position: relative"
          >
             <el-button 
              class="delete-btn"
              type="danger"
              icon="el-icon-delete"
              circle
               v-if="isEdit"
               size="mini"
               @click="deleteCard(index)"
            ></el-button>
            <div class="card-info">
              <span>{{ item.bankName }}</span>
              <span>{{ item.cardNum }}</span>
            </div>

            <!-- <i class="el-icon-success isSelect" v-show="item.show"></i> -->
          </div>
        </div>
        <el-divider></el-divider>
      </div>
      <!-- 添加银行卡按钮的容器 -->
      <div class="newCard-Box">
        <div @click="addCardDialogVisible = true" class="addCard">
          <span><i class="el-icon-plus"></i></span>
          <span>添加银行卡</span>
        </div>
      </div>
      <el-dialog
        title="添加银行卡"
        :visible.sync="addCardDialogVisible"
        width="30%"
        center
      >
        <el-form ref="form" :rules="rules" :model="form" label-width="80px">
          <el-form-item label="持卡人" prop="holder">
            <el-input maxLength="10" v-model="form.holder"></el-input>
          </el-form-item>
          <el-form-item label="银行" prop="openingBank">
            <el-select
              v-model="form.openingBank"
              placeholder="请选择开户行"
              style="width: 100%"
            >
              <el-option label="中国银行" value="中国银行"></el-option>
              <el-option label="农业银行" value="农业银行"></el-option>
              <el-option label="工商银行" value="工商银行"></el-option>
              <el-option label="建设银行" value="建设银行"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="开户行" prop="bankBranch">
            <el-input maxLength="15" v-model="form.bankBranch"></el-input>
          </el-form-item>
          <el-form-item label="开户城市" prop="cityId">
            <el-cascader
              placeholder="请选择"
              style="width: 100%"
              size="large"
              :options="options"
              v-model="form.cityId"
              @change="handleChange"
            >
            </el-cascader>
          </el-form-item>
          <el-form-item label="卡号" prop="cardNum">
            <el-input maxLength="19" v-model="form.cardNum"></el-input>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="onSubmit('form')">添加</el-button>
            <el-button @click="onCancel('form')">取消</el-button>
          </el-form-item>
        </el-form>
      </el-dialog>
    </el-card>
  </div>
</template>

<script>
import { regionData} from "element-china-area-data";
import { mapGetters, mapMutations, mapActions } from "vuex";
export default {
  data() {
    // 银行卡号验证器
    const validatecardNum = (rule, value, callback) => {
      if (/\d{19}$/.test(value)) {
        callback();
      } else {
        callback(new Error("请输入19位银行卡号"));
      }
    };
    return {
      isEdit: false,    // 银行卡可编辑状态
      options: regionData,   // 城市地区数据
      addCardDialogVisible: false,    // 添加银行卡的对话框显示状态
      form: {
        holder: "",  // 持有人
        openingBank: "",    // 开户银行
        bankBranch: "",   // 银行支行
        cardNum: "",    // 银行卡号
        cityId: "",    // 地区编号
      },
      //  表单验证对象
      rules: {
        holder: [{ required: true }, { trigger: "blur" }],
        openingBank: [{ required: true }, { trigger: ["blur", "change"] }],
        bankBranch: [{ required: true }, { trigger: "blur" }],
        cityId: [{ required: true }, { trigger: ["blur", "change"] }],
        cardNum: [
          { required: true },
          { validator: validatecardNum, trigger: "blur" },
        ],
      },
    };
  },
  methods: {
    ...mapActions({ getBankCardList: "user/getBankCard" }),  // 获取银行卡
    //  隐藏添加银行卡的窗口 重置表单
    onCancel(formName) {
      console.log("隐藏窗口");
      console.log("formName:", formName);
      this.$refs[formName].resetFields();
      this.addCardDialogVisible = false;
    },
    onSubmit(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          console.log("通过了验证");
          this.$store
            .dispatch("user/addBankCard", this.form)
            .then(() => {
              console.log("添加银行卡成功");
              this.$message({
                message: "添加银行卡成功",
                type: "success",
              });
              this.getBankCardList();
              this.onCancel("form");
            })
            .catch(() => {});
        } else {
        }
      });
    },
    handleChange(arr) {
      this.form.cityId = arr[2];
      console.log(this.form.cityId);
    },
    deleteCard(index){
      this.$confirm('确认删除？','提示', {
          confirmButtonText: '删除',
          cancelButtonText: '取消',
          type: 'warning'
        })
          .then(_ => {
            console.log('删除',index,'银行卡')
            const del_card = {'cardNum': this.bankCardList[index].cardNum}
            this.$store
            .dispatch("user/delBankCard", del_card)
            .then(() => {
              console.log("删除银行卡成功");
              this.$message({
                message: "删除银行卡成功",
                type: "success",
              });
              this.getBankCardList();
            })
            .catch(() => {});
          })
          .catch(_ => {
            console.log('取消了')
          });
    }
  },
  created() {
    this.getBankCardList();
  },
  computed: {
    ...mapGetters(["bankCardList"]),
  },
};
</script>

<style lang="scss" scoped>
.card-container {
  margin: 50px auto;
  max-width: 1000px;
}

.text {
  font-size: 14px;
}

.bankCardList {
  position: relative;
}

.item {
  margin-bottom: 18px;
}

.edit-btn {
  position: absolute;
  right: 5px;
  top: -15px;
}

.card-box {
  display: flex;
  flex-wrap: wrap;

  .delete-btn {
    position: absolute;
    right: 24px;
    top: 14px;
  }
}

.clearfix:before,
.clearfix:after {
  display: table;
  content: "";
}
.clearfix:after {
  clear: both;
}

.box-card {
  width: 100%;
}

.addCard {
  margin-left: 18px;
  width: 200px;
  height: 120px;
  background-color: #67C23A;
  border-radius: 6%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.card-info {
  background-color: rgb(206, 223, 255);
  border-radius: 6%;
  width: 200px;
  height: 120px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 8px 19px;
}

</style>
```

### 4  资产管理

#### 4.1 资产统计

> 资产统计 展示用户的资产信息，左右结构，左边是echarts图表，右边是表格的展示方法

![1626081398980](image\5C1626081398980.png)

---

- 创建 资产统计组件，views下创建assetManagement文件夹，下面创建index.vue

- 编辑路由

  ![1626082964901](image\5C1626082964901.png)

  ```javascript
  {
      path: '/assetManage',
      component: Layout,
      redirect: '/assetManage/collection',
      name: 'AssetManage',
      meta: { title: '资产管理', icon: 'el-icon-s-finance' },
      children: [
        {
          path: 'collection',
          name: 'Collection',
          component: () => import('@/views/assetManagement/index'),
          meta: { title: '资产统计'}
        },
      ]
    },
  ```

  ---

  以下是vue文件内代码

```vue
<template>
  <div class="asset-container">
    <!-- 资产统计卡片容器 -->
    <el-card class="box-card">
      <div slot="header" class="card-title">
        <span>资产统计</span>
      </div>
      <div class="box-body">
        <span>{{this.accountInfo.total}}元</span>
        <el-divider></el-divider>
        <div class="box-data">
          <!-- Echarts图表容器 -->
          <div id="myChart1" class="box-charts">Echarts</div>
          <!-- 分类金额展示表单 -->
          <div class="data-item">
            <!-- 表单数据源 tableData -->
            <el-table stripe :data="tableData" style="width: 100%">
              <el-table-column prop="name"  width="280">
              </el-table-column>
              <el-table-column prop="value" width="80" > </el-table-column>
              <el-table-column  width="35" >元</el-table-column>
            </el-table>
          </div>
        </div>
      </div>
    </el-card>
    <!-- 待收收益卡片容器 -->
    <el-card class="box-card">
      <div slot="header" class="card-title">
        <span>待收收益</span>
      </div>
      <div class="box-body">
        <span>{{this.accountInfo.interestTotal}}元</span>
        <el-divider></el-divider>
        <div class="box-data">
          <div id="myChart" class="box-charts"></div>
          <div class="data-item">
            <el-table stripe :data="tableData" style="width: 100%">
              <el-table-column prop="name"  width="280">
              </el-table-column>
              <el-table-column prop="value" width="80" > </el-table-column>
              <el-table-column  width="35" >元</el-table-column>
            </el-table>
          </div>
        </div>
      </div>
    </el-card>
    <!-- <el-button @click="drawMyCharts" type="success">成功按钮</el-button> -->
  </div>
</template>

<script>
import { mapGetters } from "vuex";
export default {
  name: "assetManage",
  mounted() {
    this.drawMyCharts();  
  },
    computed: {
    ...mapGetters(["accountInfo"]),   // 账户信息
  },
  created(){
    this.setData()  // 设置用户资产数据
  },
  data() {
    return {
      tableData: [
        {
          name: "可用余额",
          value: 500,
        },
        {
          name: "待收收益",
          value: 500,
        },
        {
          name: "待收本金",
          value: 500,
        },
        {
          name: "可用代金券",
          value: 115,
        },
      ],
    };
  },
  methods: {
    //生成 echarts图表
    drawMyCharts() {
      //  初始化图表
      let myChart = this.$echarts.init(document.getElementById("myChart"));
      let myChart1 = this.$echarts.init(document.getElementById("myChart1"));
      let option = {
        title: {
        text: '资产统计',
        left: 'center'
    },
    tooltip: {
        trigger: 'item',
        formatter: '{a} <br/>{b} : {c} ({d}%)'
    },
    toolbox: {
        show: true,
        feature: {
            mark: {show: true},
            dataView: {show: true, readOnly: false},
            restore: {show: true},
            saveAsImage: {show: true}
        }
    },
        series: [
          {
            name: '统计',
            type: 'pie',
            radius: [10, 120],
            center: ['50%', '50%'],
            roseType: 'area',
            itemStyle: {
                borderRadius: 5
            },
            data: this.tableData
          },
        ],
      };
      //  设置图表数据
      myChart.setOption(option);
      myChart1.setOption(option);
    },
    // 设置表格源数据 
    setData(){
        this.tableData[0].value = this.accountInfo.balance
        this.tableData[1].value = this.accountInfo.interestTotal
        this.tableData[2].value = this.accountInfo.profit
        this.tableData[3].value = 4220
    }
  },
};
</script>


<style lang="scss" scoped>
.asset-container {
  margin: 50px auto;
  max-width: 1000px;
}

.box-card {
  margin-bottom: 25px;
}

.card-title {
  font-size: 25px;
}

.box-data {
  display: flex;
  justify-content: space-around;

  .box-charts {
    width: 400px;
    height: 400px;
  }
}
</style>
```

---

#### 4.2 充值

> 用户须登录成功并经过实名认证后，进行此操作。若客户未经过实名认证，则点击“充值”菜单，弹出框提示“您还未经过实名认证，点击去认证，切换到账号设置的安全设置菜单，进行实名认证。点击取消返回上一页面。
>
> ![1626155703989](image\5C1626155703989.png)

![1626085027028](image\5C1626085027028.png)

---

- 先创建组件 rechage.vue

![1626157400820](image\5C1626157400820.png)

- 配置路由

  ![1626157526642](image\5C1626157526642.png)

  ```javascript
  path: 'recharge',
          name: 'recharge',
          component: () => import('@/views/assetManagement/recharge'),
          meta: { title: ' 充值'}
  ```

- 添加获取用户账户信息、请求充值的方法

  ![1626161461217](image\5C1626158136857.png)

  ```javascript
  // 获取账户信息
  export function getAccountInfo() {
    return request({
      url: '/account/funds',
      method: 'get',
    })
  }
  
  // 充值
  export function recharge(data) {
    return request({
      url: '/account/recharge',
      method: 'post',
      data:data
    })
  }
  
  ```

![1626161237510](image\5C1626161237510.png)

```
recharge, getAccountInfo
```

![1626161861709](image\5C1626161861709.png)

```javascript
// 获取账户信息
  getAccountInfo({ commit } ) {
    return new Promise(resolve => {
      getAccountInfo().then((response) => {
        console.log('账户信息:', response)
        commit('SET_ACCOUNTINFO', response.data)
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },

  // 充值
  recharge({commit}, data){
    return new Promise(resolve => {
      recharge(data).then((response) => {
        console.log('充值成功:', response)
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },
```

---

- 创建 验证码组件 （多个页面会要用到，放在components下面）

![1626158791068](C:\Users\NINGMEI\AppData\Roaming\Typora\typora-user-images\1626158791068.png)

```javascript
<template>
  <div class="s-canvas">
    <canvas id="s-canvas" :width="contentWidth" :height="contentHeight"></canvas>
  </div>
</template>
<script>
export default {
  name: 'SIdentify',
  props: {
    identifyCode: {
      type: String,
      default: '1234'
    },
    fontSizeMin: {
      type: Number,
      default: 20
    },
    fontSizeMax: {
      type: Number,
      default: 40
    },
    backgroundColorMin: {
      type: Number,
      default: 180
    },
    backgroundColorMax: {
      type: Number,
      default: 240
    },
    colorMin: {
      type: Number,
      default: 50
    },
    colorMax: {
      type: Number,
      default: 160
    },
    lineColorMin: {
      type: Number,
      default: 40
    },
    lineColorMax: {
      type: Number,
      default: 180
    },
    dotColorMin: {
      type: Number,
      default: 0
    },
    dotColorMax: {
      type: Number,
      default: 255
    },
    contentWidth: {
      type: Number,
      default: 112
    },
    contentHeight: {
      type: Number,
      default: 38
    }
  },
  methods: {
    // 生成一个随机数
    randomNum(min, max) {
      return Math.floor(Math.random() * (max - min) + min)
    },
    // 生成一个随机的颜色
    randomColor(min, max) {
      var r = this.randomNum(min, max)
      var g = this.randomNum(min, max)
      var b = this.randomNum(min, max)
      return 'rgb(' + r + ',' + g + ',' + b + ')'
    },
    drawPic() {
      var canvas = document.getElementById('s-canvas')
      var ctx = canvas.getContext('2d')
      ctx.textBaseline = 'bottom'
      // 绘制背景
      ctx.fillStyle = this.randomColor(
        this.backgroundColorMin,
        this.backgroundColorMax
      )
      ctx.fillRect(0, 0, this.contentWidth, this.contentHeight)
      // 绘制文字
      for (let i = 0; i < this.identifyCode.length; i++) {
        this.drawText(ctx, this.identifyCode[i], i)
      }
      this.drawLine(ctx)
      this.drawDot(ctx)
    },
    drawText(ctx, txt, i) {
      ctx.fillStyle = this.randomColor(this.colorMin, this.colorMax)
      ctx.font =
        this.randomNum(this.fontSizeMin, this.fontSizeMax) + 'px SimHei'
      var x = (i + 1) * (this.contentWidth / (this.identifyCode.length + 1))
      var y = this.randomNum(this.fontSizeMax, this.contentHeight - 5)
      var deg = this.randomNum(-45, 45)
      // 修改坐标原点和旋转角度
      ctx.translate(x, y)
      ctx.rotate(deg * Math.PI / 180)
      ctx.fillText(txt, 0, 0)
      // 恢复坐标原点和旋转角度
      ctx.rotate(-deg * Math.PI / 180)
      ctx.translate(-x, -y)
    },
    drawLine(ctx) {
      // 绘制干扰线
      for (let i = 0; i < 4; i++) {
        ctx.strokeStyle = this.randomColor(
          this.lineColorMin,
          this.lineColorMax
        )
        ctx.beginPath()
        ctx.moveTo(
          this.randomNum(0, this.contentWidth),
          this.randomNum(0, this.contentHeight)
        )
        ctx.lineTo(
          this.randomNum(0, this.contentWidth),
          this.randomNum(0, this.contentHeight)
        )
        ctx.stroke()
      }
    },
    drawDot(ctx) {
      // 绘制干扰点
      for (let i = 0; i < 60; i++) {
        ctx.fillStyle = this.randomColor(0, 255)
        ctx.beginPath()
        ctx.arc(
          this.randomNum(0, this.contentWidth),
          this.randomNum(0, this.contentHeight),
          1,
          0,
          2 * Math.PI
        )
        ctx.fill()
      }
    }
  },
  watch: {
    identifyCode() {
      this.drawPic()
    }
  },
  mounted() {
    this.drawPic()
  }
}
</script>

```

- 实名验证和支付密码验证的组件 checkAuth

  ![1626159840654](image\5C1626159840654.png)

  ```javascript
  <template>
      <div>
              <el-dialog
    title="提示"
    :visible.sync="dialogVisible"
    width="20%"
    :before-close="handleClose">
    <span>{{tipsTitle}}</span>
    <span slot="footer" class="dialog-footer">
      <el-button @click="goBackPage">取 消</el-button>
      <el-button type="primary" @click='goToSet'>{{btnText}}</el-button>
    </span>
  </el-dialog>
      </div>
  </template>
  
  <script>
  import { mapGetters } from "vuex";
  export default {
      name:'CheckAuth',
      data() {
        return {
          dialogVisible: false,
          // <router-link :to="{ path: '/account/card' }">
          tipsTitle:'',
          btnText:''
        };
        
      },
      computed: {
      ...mapGetters(["accountStatus"]),
    },
      methods: {
        handleClose() {
          this.$confirm('确认关闭？')
            .then(_ => {
              this.goBackPage()
            })
            .catch(_ => {});
        },
        goToSet(){
            this.dialogVisible = false
            this.$router.replace({path:'/account/safe'})
        },
        goBackPage(){
            this.dialogVisible = false
            this.$router.go(-1)
        }
  
      },
      created(){
          if(!this.accountStatus.realNameAuth){
              this.tipsTitle='您还未进行实名认证'
              this.btnText = '去认证'
              this.dialogVisible = true
          }else if(!this.accountStatus.payPwdStatus){
              this.tipsTitle='您还未设置支付密码'
              this.btnText = '去设置'
              this.dialogVisible = true
          }
      }
  }
  </script>
  ```

- rechage.vue

  ```vue
  <template>
    <div class="recharge-container">
      <!-- 权限验证组件，是否已实名，是否设置了支付密码 -->
      <CheckAuth />
      <el-card class="box-card">
        <!-- 标题 -->
        <div slot="header" class="card-title">
          <span>充值</span>
        </div>
        <div class="body-box">
          <div class="select-title">请选择银行</div>
          <!-- 银行卡容器 -->
          <!-- v-for循环创建 银行卡对象 -->
          <!-- selectedStyle 根据当前选择的索引是否是自己来应用样式 -->
          <div class="bank-box">
            <div
              v-for="index of 4"
              :key="index"
              @click="selected(index)"
              :class="{ selectedStyle: form.selectedIndex == index }"
            >
              <el-image
                :src="require(`@/assets/bank/${index}.png`)"
                lazy
              ></el-image>
            </div>
          </div>
          <el-divider></el-divider>
          <!-- 充值表单 -->
          <el-form
            ref="form"
            label-position="right"
            label-width="80px"
            :model="form"
            :rules="rules"
          >
            <el-form-item class="hide-item" prop="selectedIndex">
              <div v-if="false"><i class="el-icon-s-shelp"></i></div>
            </el-form-item>
            <el-form-item label="可用金额">
              <span>{{ this.accountInfo.balance }}元</span>
            </el-form-item>
            <el-form-item label="充值金额" prop="amount">
              <el-input-number
                :controls="false"
                v-model="form.amount"
                :min="1"
                :max="50000"
                placeholder=""
              ></el-input-number>
            </el-form-item>
            <el-form-item>
              <!-- 验证码容器 -->
              <div class="identifybox">
                <div @click="refreshCode">
                  <!-- 验证码组件 -->
                  <s-identify :identifyCode="identifyCode"></s-identify>
                </div>
              </div>
            </el-form-item>
            <el-form-item prop="verifycode">
              <el-input
                v-model="form.verifycode"
                placeholder="请输入验证码"
                class="identifyinput"
                :maxlength="4"
              ></el-input>
            </el-form-item>
            <el-form-item>
              <el-button type="primary" @click="submitForm('form')"
                >提交</el-button
              >
              <!-- <el-button @click="resetForm('ruleForm')">重置</el-button> -->
            </el-form-item>
          </el-form>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import SIdentify from "@/components/SIdentify";   // 验证码组件
  import CheckAuth from "@/components/checkAuth.vue";   // 权限验证组件
  import { mapActions, mapGetters } from "vuex";
  export default {
    data() {
      // 验证码自定义验证规则
      const validateVerifycode = (rule, value, callback) => {
        if (value === "") {
          callback(new Error("请输入验证码"));
        } else if (value !== this.identifyCode) {
          callback(new Error("验证码不正确"));
        } else {
          callback();
        }
      };
      return {
        form: {
          // 金额
          amount: 0,
          // 验证码
          verifycode: "",
          // 当前选择的索引
          selectedIndex: null,
        },
        rules: {   // 表单验证对象
          selectedIndex: [
            { required: true, message: "请选择银行卡", trigger: "change" },
          ],
          verifycode: [
            { validator: validateVerifycode, required: true, trigger: "blur" },
          ],
        },
        identifyCodes: "1234567890",
        identifyCode: "",
      };
    },
    components: { //注册组件
      SIdentify,
      CheckAuth,
    },
    mounted() {
      // 验证码初始化
      this.identifyCode = "";
      this.makeCode(this.identifyCodes, 4);
    },
    computed: {
      ...mapGetters(["accountInfo"]),
    },
    methods: {
      ...mapActions({ getAcctInfo: "user/getAccountInfo" }), // 获取账户信息
      submitForm(formName) {
        this.$refs[formName].validate((valid) => {
          if (valid) {
            console.log("通过验证");
            this.refreshCode();
            this.$store         // 表单通过验证,调用充值api
              .dispatch("user/recharge", this.form)
              .then(() => {
                this.$message({
                  message: "充值成功",
                  type: "success",
                });
                this.getAcctInfo();  // 充值成功 刷新账户信息
              })
              .catch(() => {});
          } else {
            console.log("未通过验证");
          }
        });
      },
      selected(index) {  // 设置当前选择的银行卡索引 
        if (index == this.form.selectedIndex) {
          this.form.selectedIndex = null;
        } else {
          this.form.selectedIndex = index;
        }
      },
      // 生成随机数
      randomNum(min, max) {
        return Math.floor(Math.random() * (max - min) + min);
      },
      // 切换验证码
      refreshCode() {
        this.identifyCode = "";
        this.makeCode(this.identifyCodes, 4);
      },
      // 生成四位随机验证码
      makeCode(o, l) {
        for (let i = 0; i < l; i++) {
          this.identifyCode +=
            this.identifyCodes[this.randomNum(0, this.identifyCodes.length)];
        }
        console.log(this.identifyCode);
      },
    },
  };
  </script>
  
  
  <style lang="scss" scoped>
  .recharge-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .identifybox {
      display: flex;
      max-height: 38px;
    }
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .body-box {
      .select-title {
        padding: 8px 0;
      }
    }
  
    .hide-item {
      position: relative;
      top: -50px;
    }
  
    .selectedStyle {
      .el-image {
        border: rgb(28, 104, 167) 1px solid;
      }
    }
  
    .el-image {
      border: 1px solid rgb(226, 226, 226);
      margin: 8px 19px;
    }
  
    .bank-box {
      display: flex;
    }
    .el-input {
      max-width: 200px;
    }
    .el-input-number {
      max-width: 200px;
    }
  
    .code-input {
      max-width: 100px;
    }
  }
  </style>
  ```

---

#### 4.3 提现

> - 用户须登录成功并经过实名认证后，才能进行此操作。若客户未经过实名认证，则点击“充值”菜单，弹出框提示“您还未经过实名认证，点击去认证，切换到账号设置的安全设置菜单，进行实名认证。点击取消返回上一页面。
>
> ![1626163376712](image\5C1626163376712.png)
>
> - 若用户还未添加银行卡，则默认不显示提现表单，显示添加银行卡的按钮，点击跳转到账号设置-银行卡设置
>
> ![1626163218422](image\5C1626163218422.png)

![1626085053662](image\5C1626085053662.png)

---

- 先创建组件 extract.vue

  ![1626163635494](image\5C1626163635494.png)

---

- 配置路由

  ![1626166779341](image\5C1626166779341.png)

  ```javascript
  {
          path: 'extract',
          name: 'extract',
          component: () => import('@/views/assetManagement/extract'),
          meta: { title: ' 提现'}
        }
  ```


- 添加 请求提现的方法

  ![1626163948899](image\5C1626163948899.png)

  ```javascript
  // 提现
  export function extract(data) {
    return request({
      url: '/account/extract',
      method: 'post',
      data:data
    })
  }
  ```

![1626169406895](image\5C1626169406895.png)

![1626168951548](image\5C1626168951548.png)

- extract.vue 文件

  ```vue
  <template>
    <div class="extract-container">
      <!-- 权限验证组件 -->
      <CheckAuth />
      <!-- 提现卡片容器 -->
      <el-card class="box-card">
        <div slot="header" class="card-title">
          <span>提现</span>
        </div>
        <!-- v-if 显示银行卡 或者 是 添加银行卡 -->
        <div v-if="!bankCardList.length" class="card-tips">
          <div style="color: #67c23a">请先添加银行卡</div>
          <router-link :to="{ path: '/account/card' }">
            <el-button
              class="card-addBtn"
              icon="el-icon-circle-plus-outline"
              type="success"
              >添加银行卡</el-button
            >
          </router-link>
        </div>
        <div v-else>
          <span style="margin-left: 18px">请选择收款银行卡</span>
          <!-- 银行卡容器 -->
          <div class="card-box">
            <!-- v-for 循环渲染 银行卡 -->
            <!-- borderStyle 根据当前选择的索引是否是自己来应用样式 -->
            <div
              v-for="(item, index) in bankCardList"
              :key="index"
              :class="{ borderStyle: form.selectedIndex == index }" 
              @click="selected(index)"
            >
              <div class="card-info">
                <span>{{ item.bankName }}</span>
                <span>{{ item.cardNum }}</span>
              </div>
  
              <!-- <i class="el-icon-success isSelect" v-show="item.show"></i> -->
            </div>
          </div>
          <el-divider></el-divider>
          <!-- 提现表单容器 -->
          <div class="extract-form">
            <!-- 提现表单 -->
            <el-form
              ref="form"
              label-position="right"
              label-width="80px"
              :model="form"
              :rules="rules"
            >
              <el-form-item class="hide-item" prop="selectedIndex">
                <div v-if="false"><i class="el-icon-s-shelp"></i></div>
              </el-form-item>
              <el-form-item label="可取金额">
                <span>{{ this.accountInfo.balance }}元</span>
              </el-form-item>
              <el-form-item label="提取金额" prop="amount">
                <el-input-number
                  :controls="false"
                  v-model="form.amount"
                  :min="1"
                  :max="accountInfo.balance"
                ></el-input-number>
              </el-form-item>
              <!-- <el-form-item label="手续费">
                <span> 18元,实际到账xxxx元</span>
              </el-form-item> -->
              <el-form-item>
                <!-- 验证码容器 -->
                <div class="identifybox">
                  <div @click="refreshCode">
                    <!-- 验证码组件 -->
                    <s-identify :identifyCode="identifyCode"></s-identify>
                  </div>
                </div>
              </el-form-item>
              <el-form-item prop="verifycode">
                <el-input
                  v-model="form.verifycode"
                  placeholder="请输入验证码"
                  class="identifyinput"
                ></el-input>
              </el-form-item>
              <el-form-item label="支付密码" prop="passwd">
                <el-input type="password" v-model="form.passwd"></el-input>
              </el-form-item>
              <el-form-item>
                <el-button type="primary" @click="submitForm('form')"
                  >提交</el-button
                >
              </el-form-item>
            </el-form>
          </div>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import { mapGetters, mapMutations, mapActions } from "vuex";
  import SIdentify from "@/components/SIdentify";    // 验证码组件
  import CheckAuth from "@/components/checkAuth.vue";   // 权限验证组件 是否已实名，是否设置了支付密码 
  export default {
    name: "extract",
    data() {
      // 验证码自定义验证规则
      const validateVerifycode = (rule, value, callback) => {
        if (value === "") {
          callback(new Error("请输入验证码"));
        } else if (value !== this.identifyCode) {
          console.log("validateVerifycode:", value);
          callback(new Error("验证码不正确!"));
        } else {
          callback();
        }
      };
      return {
        // 表单绑定对象
        form: {
          amount: 0,
          passwd: "",
          code: "",
          verifycode: "",
          selectedIndex: null,
        },
        // 验证器对象
        rules: {
          selectedIndex: [
            { required: true, message: "请选择银行卡", trigger: "change" },
          ],
          passwd: [{ required: true, trigger: "blur", message: "请输入密码" }],
          verifycode: [
            { validator: validateVerifycode, required: true, trigger: "blur" },
          ],
        },
        identifyCodes: "1234567890",
        identifyCode: "",
      };
    },
    components: {  // 注册的组件
      SIdentify,
      CheckAuth,
    },
    mounted() {
      // 验证码初始化
      this.identifyCode = "";
      this.makeCode(this.identifyCodes, 4);
    },
    methods: {
      // getAcctInfo 获取账户信息 getBankCard 获取银行卡列表
      ...mapActions({ getAcctInfo: "user/getAccountInfo", getBankCardList: "user/getBankCard" }),
      toggle(item) {
        item.show = !item.show;
      },
      selected(index) {
        // 设置当前选择的银行卡索引
        if (index == this.form.selectedIndex) {
          this.form.selectedIndex = null;
        } else {
          this.form.selectedIndex = index;
        }
      },
      // 生成随机数
      randomNum(min, max) {
        return Math.floor(Math.random() * (max - min) + min);
      },
      // 切换验证码
      refreshCode() {
        this.identifyCode = "";
        this.makeCode(this.identifyCodes, 4);
      },
      // 生成四位随机验证码
      makeCode(o, l) {
        for (let i = 0; i < l; i++) {
          this.identifyCode +=
            this.identifyCodes[this.randomNum(0, this.identifyCodes.length)];
        }
        console.log(this.identifyCode);
      },
      // 提交表单
      submitForm(formName) {
        this.$refs[formName].validate((valid) => {
          if (valid) {
            console.log("通过验证");
            this.refreshCode()
            var tem_form = {
              'card_id' : this.bankCardList[this.form.selectedIndex].card_id,
              'amount' : this.form.amount,
              'payPwd' : this.form.passwd
            }
          //  调用 请求提现api的方法
           this.$store
              .dispatch("user/extract", tem_form)
              .then(() => {
                this.$message({
                  message: "提现成功",
                  type: "success",
                });
                // 刷新账户信息
                this.getAcctInfo();
                this.form.amount = 0
              })
              .catch(() => {});
          } else {
            console.log("未通过");
          }
        });
      },
    },
    created() {
      this.getBankCardList(); 
    },
    computed: {
      ...mapGetters(["bankCardList", "accountInfo"]),
    },
  };
  </script>
  
  <style lang="scss" scoped>
  .extract-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .identifybox {
      display: flex;
      max-height: 38px;
    }
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
    .card-addBtn {
      margin: 8px 0;
    }
  
    .card-box {
      display: flex;
      flex-wrap: wrap;
    }
  
    .borderStyle {
      .card-info {
        border: rgb(0, 0, 0) 1px dashed;
      }
    }
  
    .bankCard {
      height: 155px;
      .isSelect {
        //   position: relative;
        color: rgb(2, 204, 2);
        margin-left: 20px;
        // left:55px;
        // top:15px;
        //   bottom: -18px;
        //   right: -75px;
      }
    }
  
     .hide-item {
      position: relative;
      top: -50px;
    }
  
    .card-info {
      background-color: rgb(206, 223, 255);
      border-radius: 6%;
      width: 200px;
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 8px 19px;
    }
  
    .el-input {
      max-width: 200px;
    }
  }
  </style>
  ```

### 5.投资管理

#### 5.1我的投资

> 我的投资界面显示当前登录用户购买的理财计划，分为购买中的（未匹配借款），回款中的（已匹配，开始产生收益了），已完成的（投资到期的）
>
> 可以根据日期进行筛选

![1632328643137](image\5C1632328643137.png)

---

- 先创建组件，views下创建invest文件夹，下面创建myInvest.vue


![1632328853224](image\5C1632328853224.png)

- 配置路由


> src-router-index.js

![1632329093772](image\5C1632329093772.png)

---

-  编写页面


先添加查询我的投资的API和方法

![1635237125866](image\5C1635237125866.png)

![1632329765969](image\5C1632329765969.png)

![1632329889081](image\5C1632329889081.png)

myInvest.vue文件

```vue
<template>
  <div class="invest-container">
    <el-card class="box-card">
      <div slot="header" class="card-title">
        <span>我的投资</span>
      </div>
      <div class="body-box">
        <!-- 日期选择容器 -->
        <div class="date-selecter">
          <span class="demonstration">日期选择</span>
          <el-date-picker
            v-model="value2"
            type="daterange"
            unlink-panels
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            :picker-options="pickerOptions"
          >
          </el-date-picker>
          <el-button @click="search" type="success">查询</el-button>
        </div>
        <!-- 投资计划容器 -->
        <div class="table-box">
          <el-tabs type="border-card" @tab-click="handleClick">
            <el-tab-pane
              v-for="(item, index) in playList"
              :key="index"
              :label="item"
            >
              <el-table
                :data="tableData"
                stripe
                style="width: 100%"
                :header-cell-style="{ background: '#e1e4e5' }"
              >
                <el-table-column prop="plan_name" label="计划名称" min-width="1">
                </el-table-column>
                <el-table-column prop="invest_amount" label="投资金额(元)" min-width="1">
                </el-table-column>
                <el-table-column prop="yearRate" label="年利率" min-width="1">
                </el-table-column>
                <el-table-column prop="totalIncome" label="待收本息(元)" min-width="1">
                </el-table-column>
                <el-table-column prop="month_Income" label="月手本息(元)" min-width="1">
                </el-table-column>
                <el-table-column prop="period" label="期数" min-width="1">
                </el-table-column>
                <el-table-column prop="deal_date" label="购买时间" min-width="1">
                </el-table-column>
                <el-table-column prop="start_date" label="生效时间" min-width="1">
                </el-table-column>
                <el-table-column prop="remark" label="备注" min-width="1">
                </el-table-column>
              </el-table>
            </el-tab-pane>
          </el-tabs>
        </div>
        <!-- 分页 -->
        <el-pagination
          background
          class="paginate"
          layout="prev, pager, next"
          :page-size="filterRange.perPage"
          :current-page="filterRange.curPage"
          :page-count="totalPages"
          @current-change="onPageChange"
        >
        </el-pagination>
      </div>
    </el-card>
  </div>
</template>


<script>
import { mapActions } from "vuex";
export default {
  data() {
    return {
      playList: ["购买中的计划", "回款中的计划", "已完成的计划"],
      pickerOptions: {
        shortcuts: [
          {
            text: "最近一周",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
              picker.$emit("pick", [start, end]);
            },
          },
          {
            text: "最近一个月",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
              picker.$emit("pick", [start, end]);
            },
          },
          {
            text: "最近三个月",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
              picker.$emit("pick", [start, end]);
            },
          },
        ],
      },
      value1: "",
      value2: "",
      totalPages: 1,
      filterRange: {
        start: "",
        end: "",
        curPage: 1,
        perPage: 3,
        invest_type: 0,
      },
      tableData: [],
    };
  },
  methods: {
    ...mapActions({ getInvestList: "invest/getInvestRecord" }), // 获取投资记录列表
    get_investRecordList() {
      this.getInvestList(this.filterRange)
        .then((data) => {
          if (data) {
            this.tableData = data.content;
            this.totalPages = data.paginateInfo.pages;
          }
        })
        .catch(() => {});
    },
    handleClick(tab, event){
      this.filterRange.invest_type = parseInt(tab.index)
      this.get_investRecordList()
    },
    search() {
      this.filterRange.curPage = 1
      this.get_delRecordList();
    },
    onPageChange(val) {
      this.filterRange.curPage = val;
      this.get_investRecordList();
    },
    showRange() {
      if (this.value2) {
        this.filterRange.start = this.value2[0];
        this.filterRange.end = this.value2[1];
      } else {
        this.filterRange.start = "";
        this.filterRange.end = "";
      }
    },
  },
  computed: {},
  created(){
    this.get_investRecordList()
  }
};
</script>

<style lang="scss" scoped>
.invest-container {
  .selected {
    background: blue;
  }

  .table-box {
    margin-top: 12px;
  }

  .el-date-editor {
    margin: 0 10px;
  }

  .tag-BOX {
    .el-tag {
      margin-right: 12px;
    }
  }

  margin: 50px auto;
  max-width: 1000px;

  .text {
    font-size: 14px;
  }

  .item {
    margin-bottom: 18px;
  }

  .clearfix:before,
  .clearfix:after {
    display: table;
    content: "";
  }
  .clearfix:after {
    clear: both;
  }

  .card-title {
    font-size: 22px;
    color: #409eff;
  }

  .box-card {
    .paginate{
      margin-top: 10px;
    }
  }
}
</style>
```

#### 5.2交易记录

> 交易记录包含了当前用户所有的交易行为记录（全部，充值，提现等），可点击标签进行筛选，可按日期进行筛选

![1632361440226](image\5C1632361440226.png)

---

- 先创建组件，views下创建invest文件夹，下面创建dealRecord.vue

![1632361908568](image\5C1632361908568.png)

- 配置路由

  > src-router-index.js

  ![1632362332605](image\5C1632362332605.png)

---

- 编写页面

先添加请求接口的API和方法

![1635237319676](image\5C1635237319676.png)

![1632361844567](image\5C1632361844567.png)

---

 dealRecord.vue 文件

```vue

<template>
  <div class="dealRecord-container">
    <el-card class="box-card">
      <div slot="header" class="card-title">
        <span>交易记录</span>
      </div>
      <div class="body-box">
        <!-- 标签容器 -->
        <div class="tag-BOX">
          <span class="banner_title">交易类型</span>
          <el-tag
            v-for="(item, index) in tags"
            :key="index"
            :effect="change(index)"
            type="success"
            @click="changeType(index)"
          >
            {{ item }}
          </el-tag>
        </div>
        <el-divider></el-divider>
        <!-- 日期选择容器 -->
        <div class="date-selecter">
          <span class="banner_title">日期选择</span>
          <span class="demonstration">选择日期</span>
          <el-date-picker
            v-model="dateValue"
            type="daterange"
            value-format="yyyy-MM-dd HH:hh:ss"
            unlink-panels
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            :picker-options="pickerOptions"
            @change="showRange"
          >
          </el-date-picker>
          <el-button @click="search" type="success">查询</el-button>
        </div>
        <!-- 交易记录表 -->
        <div class="table-box">
          <el-table
            :data="tableData"
            stripe
            style="width: 100%"
            :header-cell-style="{ background: '#e1e4e5' }"
          >
            <el-table-column prop="deal_date" label="时间" min-width="1">
            </el-table-column>
            <el-table-column prop="deal_type" label="交易类型" min-width="1">
            </el-table-column>
            <el-table-column prop="descrp" label="交易详情" min-width="2">
            </el-table-column>
            <el-table-column prop="deal_amount" label="金额(元)" min-width="2">
            </el-table-column>
            <el-table-column prop="aAfter_Money" label="余额(元)" min-width="2">
            </el-table-column>
            <el-table-column prop="deal_status" label="状态" min-width="1">
            </el-table-column>
          </el-table>
        </div>
        <!-- 分页 -->
        <el-pagination
          background
          class="paginate"
          layout="prev, pager, next"
          :page-size="filterRange.perPage"
          :current-page="filterRange.curPage"
          :page-count="totalPages"
          @current-change="onPageChange"
        >
        </el-pagination>
      </div>
    </el-card>
  </div>
</template>


<script>
import { mapActions } from "vuex";
export default {
  data() {
    return {
      tags: ["全部", "充值", "提现", "投资", "收益", "回收本金"],
      pickerOptions: {
        shortcuts: [
          {
            text: "最近一周",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
              picker.$emit("pick", [start, end]);
            },
          },
          {
            text: "最近一个月",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
              picker.$emit("pick", [start, end]);
            },
          },
          {
            text: "最近三个月",
            onClick(picker) {
              const end = new Date();
              const start = new Date();
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
              picker.$emit("pick", [start, end]);
            },
          },
        ],
      },
      // 日期值
      dateValue: "",
      // 分页记录总页数
      totalPages: 1,
      // 筛选范围（开始日期，结束日期，当前页，每页记录数，交易类型）
      filterRange: {
        start: "",
        end: "",
        curPage: 1,
        perPage: 3,
        deal_type: 0,
      },
      // 表单数据
      tableData: [],
    };
  },
  methods: {
    ...mapActions({ getRecordList: "transaction/getDealRecord" }), // 获取交易记录列表
    get_delRecordList() {
      // 根据选择的交易类型，请求交易记录
      this.getRecordList(this.filterRange)
        .then((data) => {
          if (data) {
            // 设置表单数据
            this.tableData = data.content;
            // 设置分页的总页数
            this.totalPages = data.paginateInfo.pages;
          }
        })
        .catch(() => {});
    },
    // 查询交易记录，默认请求分页的第一页数据
    search() {
      this.filterRange.curPage = 1;
      this.get_delRecordList();
    },
    // 设置当前选中的交易类型
    changeType(index) {
      this.filterRange.deal_type = index;
    },
    // 改变页码的时候搜索
    onPageChange(val) {
      this.filterRange.curPage = val;
      this.get_delRecordList();
    },
    // 日期选择器 用户确认选定的值时触发
    showRange() {
      if (this.dateValue) {
        this.filterRange.start = this.dateValue[0];
        this.filterRange.end = this.dateValue[1];
      } else {
        this.filterRange.start = "";
        this.filterRange.end = "";
      }
    },
  },
  created() {
    this.get_delRecordList();
  },
  computed: {
    // 根据当前选中的类别来设置标签的颜色
    change() {
      return function (index) {
        if (this.filterRange.deal_type == index) {
          return "dark";
        } else {
          return "plain";
        }
      };
    },
  },
};
</script>

<style lang="scss" scoped>
.dealRecord-container {
  .selected {
    background: blue;
  }

  .table-box {
    margin-top: 12px;
  }

  .banner_title {
    padding-right: 15px;
  }

  .el-date-editor {
    margin: 0 10px;
  }

  .tag-BOX {
    .el-tag {
      margin-right: 12px;
    }
  }

  margin: 50px auto;
  max-width: 1000px;

  .text {
    font-size: 14px;
  }

  .item {
    margin-bottom: 18px;
  }

  .clearfix:before,
  .clearfix:after {
    display: table;
    content: "";
  }
  .clearfix:after {
    clear: both;
  }

  .box-card {
    .paginate{
      margin-top: 10px;
    }
  }

  .card-title {
    font-size: 22px;
    color: #409eff;
  }
}
</style>
```

#### 5.3预期收益

> 当用户购买的理财产品，成功匹配了借款人的债权的时候，就会产生预期收益表，就会在此页面显示。
>
> 投资到期日未到的时候，提取收益按钮为灰色，不可操作。
>
> 投资到期后，提取按钮变为正常，可以提取，提取后按钮状态变为不可操作的已提取状态。

![1632364285711](image\5C1632364285711.png)

---

先创建组件，views下创建invest文件夹，下面创建expectedReturn.vue

![1632364364929](image\5C1632364364929.png)

配置路由

> src-router-index.js

![1632364486630](image\5C1632364486630.png)

---

- 编写页面

  先添加请求接口的API和方法（获取预期收益表，获取产品列表，提取收益）

  ![1632365148706](image\5C1632365148706.png)

![1632365239359](image\5C1632365239359.png)

![1632365313532](image\5C1632365313532.png)

![1632365370945](image\5C1632365370945.png)

![1632365420564](image\5C1632365420564.png)

expectedReturn.vue文件

```vue
<template>
  <div class="return-container">
    <el-card class="box-card">
      <div slot="header" class="card-title">
        <span>预期收益</span>
      </div>
      <div class="body-box">
        <div class="table-box">
          <el-table
            :data="tableData"
            stripe
            style="width: 100%"
            :header-cell-style="{ background: '#e1e4e5' }"
          >
            <el-table-column
              prop="productId"
              :formatter="stateFormat"
              label="产品"
              min-width="1"
            >
            </el-table-column>
            <el-table-column
              prop="investRcordID"
              label="投资记录"
              min-width="3"
            >
            </el-table-column>
            <el-table-column prop="expectedDate" label="收益日期" min-width="2">
            </el-table-column>
            <el-table-column prop="return_Money" label="收益金额" min-width="2">
            </el-table-column>
            <el-table-column label="操作" min-width="2">
              <template slot-scope="exReturn">
                <!-- 当前这条数据可提取金额>0，提取按钮文字为(提取收益),并检查投资日期是否到期来设置是否可点击。
                      当前这条数据可提取金额<0，提取按钮文字为(已提取),并设置不可点击。
                 -->
                <el-button
                  size="small"
                  v-if="exReturn.row.return_Money > 0"
                  @click="applyReturn(exReturn.row.return_id)"
                  :disabled="
                    checkDisable(
                      exReturn.row.expectedStamp,
                      exReturn.row.return_Money
                    )
                  "
                  type="success"
                  >提取收益</el-button
                >
                <el-button size="small" v-else disabled type="info"
                  >已提取</el-button
                >
              </template>
            </el-table-column>
          </el-table>
        </div>
        <!-- 分页 -->
        <el-pagination
          background
          class="paginate"
          layout="prev, pager, next"
          :page-size="pageRange.perPage"
          :current-page="pageRange.curPage"
          :page-count="totalPages"
          @current-change="onPageChange"
        >
        </el-pagination>
      </div>
    </el-card>
  </div>
</template>

<script>
import { mapActions, mapGetters } from "vuex";
export default {
  data() {
    return {
      totalPages: 1,
      pageRange: {
        curPage: 1,
        perPage: 3,
      },
      tableData: [],
    };
  },
  methods: {
    ...mapActions({
      // 获取预期收益
      getExceptedReturn: "transaction/getExceptedReturn",
      // 获取产品列表
      getProList: "invest/getProductList",
      //  提取收益
      getInvestIncome: "transaction/getIncome",
    }),
    get_returns() {
      this.getExceptedReturn(this.pageRange)
        .then((data) => {
          if (data) {
            this.tableData = data.content;
            this.totalPages = data.paginateInfo.pages;
          }
        })
        .catch(() => {});
    },
    onPageChange(val) {
      this.pageRange.curPage = val;
      this.get_returns();
    },
    // 格式化产品名称
    stateFormat(row, column) {
      return this.productList[row.productId - 1].productName;
    },
    // 判断投资计划是否到期
    checkDisable(stamp, return_money) {
      const cur_date = new Date(); // 当前日期
      const ex_date = new Date(stamp * 1000); // 投资计划到期日期
      return !(cur_date > ex_date);
    },
    // 提取收益
    applyReturn(id) {
      const request_id = {
        return_id: id,
      };
      this.getInvestIncome(request_id)
        .then((data) => {
          if (data) {
            this.$message({
              message: "提取收益成功",
              type: "success",
            });
          }
          this.get_returns();
        })
        .catch(() => {});
    },
  },
  computed: {
    // 拿vuex里面的产品列表，可能为空
    ...mapGetters(["productList"]),
  },
  created() {
    // 产品列表为空就请求产品列表
    if (!this.productList.length) {
      this.getProList();
    }
    this.get_returns();
  },
};
</script>

<style lang="scss" scoped>
.return-container {
  margin: 50px auto;
  max-width: 1000px;

  .message-card {
    width: 100%;
    min-height: 200px;
  }

  .card-title {
    font-size: 22px;
    color: #409eff;
  }

  .banner_title {
    padding-right: 15px;
  }

  .el-date-editor {
    margin: 0 10px;
  }

  .table-box {
    margin-top: 12px;
  }

  .box-card {
    .paginate {
      margin-top: 10px;
    }
  }
}
</style>


```

### 6.撮合管理

#### 6.1资金队列

> 资金队列页面分2个标签页。
>
> 待匹配标签显示当前所有未匹配和部分匹配的投资形成的未匹配资金。
>
> 已匹配显示全部完全匹配的资金。
>
> 匹配债权会将未匹配或部分匹配的资金 与 未匹配和部分匹配的债权进行撮合匹配。

![1632366731948](image\5C1632366731948.png)

---

- 先创建组件，views下创建match文件夹，下面创建fundingNotMatched.vue

![1632367163754](image\5C1632367163754.png)

- 配置路由

  > src-router-index.js

  ![1632367374703](image\5C1632367374703.png)

  ---

- 编写页面

  先添加获取资金队列和匹配债权的API和方法

  ![1632367554508](image\5C1632367554508.png)

  ![1632367629447](image\5C1632367629447.png)

  ![1632367699299](image\5C1632367699299.png)

  fundingNotMatched.vue文件

  ```vue
  <template>
    <div class="funds-container">
      <el-card class="box-card">
        <div slot="header" class="card-title">
          <span>资金队列</span>
        </div>
        <div class="body-box">
          <!-- 资金队列容器 -->
          <div class="table-box">
            <el-tabs type="border-card" @tab-click="handleClick">
              <el-tab-pane
                v-for="(item, index) in playList"
                :key="index"
                :label="item"
              >
                <el-table
                  :data="tableData"
                  stripe
                  style="width: 100%"
                  :header-cell-style="{ background: '#e1e4e5' }"
                >
                  <el-table-column prop="username" label="用户名" min-width="1">
                  </el-table-column>
                  <el-table-column
                    prop="InvestRecordNum"
                    label="投资编号"
                    min-width="2"
                  >
                  </el-table-column>
                  <el-table-column
                    prop="productName"
                    label="投资产品"
                    min-width="1"
                  >
                  </el-table-column>
                  <el-table-column
                    prop="investDate"
                    label="投资时间"
                    min-width="1"
                  >
                  </el-table-column>
                  <el-table-column prop="period" label="期限" min-width="1">
                  </el-table-column>
                  <el-table-column
                    prop="notMatchedMoney"
                    label="待匹配金额"
                    min-width="2"
                  >
                  </el-table-column>
                  <el-table-column
                    prop="matchStatus"
                    :formatter="stateFormat"
                    label="匹配状态"
                    min-width="2"
                  >
                  </el-table-column>
                </el-table>
              </el-tab-pane>
            </el-tabs>
          </div>
          <div class="bottomBox">
            <!-- 分页 -->
            <el-pagination
              background
              layout="prev, pager, next"
              :page-size="filterRange.perPage"
              :current-page="filterRange.curPage"
              :page-count="totalPages"
              @current-change="onPageChange"
            >
            </el-pagination>
            <!-- 匹配债权 -->
            <el-button
              v-if="!filterRange.type"
              :disabled="!tableData.length"
              type="success"
              @click="startMatch"
              >匹配债权</el-button
            >
          </div>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import { mapActions } from "vuex";
  export default {
    data() {
      return {
        playList: ["待匹配", "已匹配"],  // 标签页
        totalPages: 1,
        filterRange: {
          curPage: 1,
          perPage: 3,
          type: 0,
        },
        tableData: [],
      };
    },
    methods: {
      ...mapActions({
        getFundList: "transaction/getFundsNotMatched",  // 获取资金列表
        matchDebt: "transaction/matchUp",               // 撮合匹配
      }), // 获取未匹配资金列表
      onPageChange(val) {
        this.filterRange.curPage = val;
        this.getNotMatchedList();
      },
      stateFormat(row) {
        if (row.matchStatus == 0) {
          return "未匹配";
        } else if (row.matchStatus == 1) {
          return "部分匹配";
        } else {
          return "已匹配";
        }
      },
      getNotMatchedList() {
        this.getFundList(this.filterRange)
          .then((data) => {
            if (data) {
              this.tableData = data.content;
              this.totalPages = data.paginateInfo.pages;
            }
          })
          .catch(() => {});
      },
      // 点击 表格标签
      handleClick(tab, event) {
        this.filterRange.type = parseInt(tab.index);  // 设置当前的类别 （待匹配/已匹配）
        this.getNotMatchedList();
      },
      startMatch() {
        this.matchDebt()
          .then((data) => {
            if (data) {
              this.getNotMatchedList();
            }
          })
          .catch(() => {});
      },
    },
    computed: {},
    created() {
      this.getNotMatchedList();
    },
  };
  </script>
  
  <style lang="scss" scoped>
  .loan-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .banner_title {
      padding-right: 15px;
    }
  
    .el-date-editor {
      margin: 0 10px;
    }
  
    .table-box {
      margin-top: 12px;
    }
  }
  </style>
  
  
  <style lang="scss" scoped>
  .funds-container {
    .banner_title {
      padding-right: 15px;
    }
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .el-date-editor {
      margin: 0 10px;
    }
  
    .tag-BOX {
      .el-tag {
        margin-right: 12px;
      }
    }
  
    margin: 50px auto;
    max-width: 1000px;
  
    .text {
      font-size: 14px;
    }
  
    .item {
      margin-bottom: 18px;
    }
  
    .clearfix:before,
    .clearfix:after {
      display: table;
      content: "";
    }
    .clearfix:after {
      clear: both;
    }
  
    .box-card {
    }
  
    .bottomBox {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
    }
  }
  </style>
  ```


#### 6.2匹配结果

> 匹配结果页面可以查询到所有撮合匹配的结果，包含（投资编号，债权编号，匹配金额等信息），可根据日期筛选

![1632368578085](image\5C1632368578085.png)

---

- 先创建组件，match文件夹下面创建matched_result.vue

![1632368656144](image\5C1632368656144.png)

- 配置路由

  > src-router-index.js

  ![1632368726282](image\5C1632368726282.png)

  ------

- 编写页面

  先添加请求匹配结果的API和方法

  ![1632368871168](image\5C1632368871168.png)

  ![1632369079546](image\5C1632369079546.png)

  ![1632369126864](image\5C1632369126864.png)

  matched_result.vue文件

  ```vue
  <template>
    <div class="matched-result-container">
      <el-card class="box-card">
        <div slot="header" class="card-title">
          <span>匹配结果</span>
        </div>
        <div class="body-box">
          <!-- 日期选择容器 -->
          <div class="date-selecter">
            <span class="banner_title">日期选择</span>
            <span class="demonstration">选择日期</span>
            <el-date-picker
              v-model="dateValue"
              type="daterange"
              value-format="yyyy-MM-dd HH:hh:ss"
              unlink-panels
              range-separator="至"
              start-placeholder="开始日期"
              end-placeholder="结束日期"
              :picker-options="pickerOptions"
              @change="showRange"
            >
            </el-date-picker>
            <el-button @click="search" type="success">查询</el-button>
          </div>
          <!-- 匹配结果容器 -->
          <div class="table-box">
            <el-table
              :data="tableData"
              stripe
              style="width: 100%"
              :header-cell-style="{ background: '#e1e4e5' }"
            >
              <el-table-column prop="transNo" label="匹配流水号" min-width="2">
              </el-table-column>
              <el-table-column prop="userId" label="投资人编号" min-width="1">
              </el-table-column>
              <el-table-column prop="investId" label="投资编号" min-width="1">
              </el-table-column>
              <el-table-column prop="debtId" label="债权编号" min-width="1">
              </el-table-column>
              <el-table-column prop="Money" label="匹配金额" min-width="1">
              </el-table-column>
              <el-table-column prop="matchDate" label="匹配时间" min-width="2">
              </el-table-column>
            </el-table>
          </div>
          <el-pagination
            background
            class="paginate"
            layout="prev, pager, next"
            :page-size="filterRange.perPage"
            :current-page="filterRange.curPage"
            :page-count="totalPages"
            @current-change="onPageChange"
          >
          </el-pagination>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import { mapActions } from "vuex";
  export default {
    data() {
      return {
        pickerOptions: {
          shortcuts: [
            {
              text: "最近一周",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
                picker.$emit("pick", [start, end]);
              },
            },
            {
              text: "最近一个月",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
                picker.$emit("pick", [start, end]);
              },
            },
            {
              text: "最近三个月",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
                picker.$emit("pick", [start, end]);
              },
            },
          ],
        },
        // 日期数据
        dateValue: null,
        totalPages: 1,
        filterRange: {
          start: "",
          end: "",
          curPage: 1,
          perPage: 3,
        },
        tableData: [],
      };
    },
    methods: {
      ...mapActions({ getList: "transaction/getMatchedList" }), // 获取匹配结果列表
      getMatchedList() {
        this.getList(this.filterRange)
          .then((data) => {
            if (data) {
              this.tableData = data.content;
              this.totalPages = data.paginateInfo.pages;
            }
          })
          .catch(() => {});
      },
      showRange() {
        if (this.dateValue) {
          this.filterRange.start = this.dateValue[0];
          this.filterRange.end = this.dateValue[1];
        } else {
          this.filterRange.start = "";
          this.filterRange.end = "";
        }
      },
      search() {
        this.filterRange.curPage = 1;
        this.getMatchedList();
      },
      onPageChange(val) {
        this.filterRange.curPage = val;
        this.getMatchedList();
      },
    },
    computed: {},
    created() {
      this.getMatchedList();
    },
  };
  </script>
  
  <style lang="scss" scoped>
  .matched-result-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .banner_title {
      padding-right: 15px;
    }
  
    .el-date-editor {
      margin: 0 10px;
    }
  
    .table-box {
      margin-top: 12px;
    }
  
    .paginate{
        margin-top: 10px;
      }
  }
  </style>
  
  
  
  ```

### 7.奖励管理

> 奖励管理页面展示用户的注册邀请码以及用户成功邀请的用户列表和所得奖励

![1632369617652](image\5C1632369617652.png)

---

- 先创建组件，views下创建award文件夹，下面创建index.vue

![1632369718669](C:\Users\NINGMEI\AppData\Roaming\Typora\typora-user-images\1632369718669.png)

- 配置路由

  > src-router-index.js

  ![1632369977215](image\5C1632369977215.png)

---

- 编写页面

  先添加获取注册邀请码和已邀请列表的API和方法

  ![1632370713736](image\5C1632370713736.png)

  ![1632370647344](image\5C1632370647344.png)

![1632370292970](image\5C1632370292970.png)

index.vue 文件

```vue
<template>
  <div class="award-container">
    <el-card class="box-card">
      <!-- 标题 -->
      <div slot="header" class="card-title">
        <span>奖励邀请</span>
      </div>
      <div class="body-box">
        <div class="help-txt">
          <!--Element UI 的 el-alert  -->
          <el-alert
            title="邀新有奖! 好友通过自己的邀请码注册有奖励,点击下方按钮复制邀请码"
            type="success"
            :closable="false"
            effect="dark"
            center
          >
          </el-alert>
          <el-button
            :disabled="v_code.length > 0"
            @click="createCode"
            style="margin-right: 5px"
            type="primary"
            >生成邀请码</el-button
          >
          <el-input class="code_label" v-model="v_code" :readonly="true">
          </el-input>
          <div>
            <el-button
              v-clipboard:copy="v_code"
              v-clipboard:success="onCopy"
              v-clipboard:error="onError"
              type="primary"
              style="margin-top: 5px"
              >复制邀请码</el-button
            >
          </div>
        </div>
        <el-divider></el-divider>
        <el-card class="invited-box">
          <div slot="header" class="clearfix">
            <span>已邀请名单</span>
          </div>
          <el-table border :data="tableData" stripe style="width: 100%">
            <el-table-column prop="name" label="已邀请用户" width="180">
            </el-table-column>
            <el-table-column prop="registerTime" label="注册时间" width="180">
            </el-table-column>
            <el-table-column prop="award" label="奖励"> </el-table-column>
          </el-table>
        </el-card>
      </div>
    </el-card>
  </div>
</template>

<script>
import { mapGetters, mapActions } from "vuex";

export default {
  data() {
    return {
      v_code: "",
      tableData: [
        
      ],
    };
  },
  components: {
    //注册组件
  },
  mounted() {},
  created() {
    // 初始化页面 获取用户的邀请码 获取已邀请用户列表
    this.v_code = this.invite_code || '';
    this.getInvitedList().then((data) => {
            if (data) {
              this.tableData = data.list;
            }
          })
          .catch(() => {});
  },
  computed: {
    ...mapGetters(["invite_code"]),   // 从vuex里面获取 用户的邀请码
  },
  methods: {
    ...mapActions({ setInviteCode: "user/setInviteCode", getInvitedList: 'user/getInvitedList' }), //  保存用户的邀请码，获取已邀请用户列表
    // 生成当前用户的邀请码
    createCode() {
      var s = [];
      var hexDigits = "0123456789abcdefghijklmnopq";   // 备选字符
      // 随机获取6位添加到数组
      for (var i = 0; i < 6; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
      }
      // 将数组每一位用空字符拼接成字符串
      var tem_invite_code = s.join("");
      // 保存用户的邀请码到数据库
      if (!this.v_code.length > 0) {
        var data = { code: tem_invite_code };
        this.setInviteCode(data)
          .then((data) => {
            if (data) {
              this.v_code = data.invite_code;
            }
          })
          .catch(() => {});
      }
    },
    onCopy() {
      alert("已复制");
    },
    onError() {
      alert("复制失败");
    },
  },
};
</script>


<style lang="scss" scoped>
.award-container {
  margin: 50px auto;
  max-width: 1000px;

  .card-title {
    font-size: 22px;
    color: #409eff;
  }

  .code_label {
    width: 350px;
  }

  .el-alert {
    margin-bottom: 15px;
  }
}
</style>
```

### 8.借款管理

#### 8.1 借款审批

> 借款审批显示所有借款申请，可进行审批操作（通过，驳回），审批过的借款在已审批界面显示。
>
> 可通过日期选择器进行筛选

![1632373514828](image\5C1632373514828.png)

---

- 先创建组件，views下创建loan文件夹，下面创建index.vue

![1632373684352](image\5C1632373684352.png)

- 配置路由

  > src-router-index.js

  ![1632374375439](image\5C1632374375439.png)

  ---

- 编写页面

  先添加获取借款申请列表和更新借款审批状态的API和方法

  ![1632374545270](image\5C1632374545270.png)

  ![1632374636629](image\5C1632374636629.png)

  index.vue文件

  ```vue
  <template>
    <div class="loan-container">
      <el-card class="box-card">
        <div slot="header" class="card-title">
          <span>借款管理</span>
        </div>
        <div class="body-box">
          <!-- 日期选择容器 -->
          <div class="date-selecter">
            <span class="banner_title">日期选择</span>
            <span class="demonstration">选择日期</span>
            <el-date-picker
              v-model="dateValue"
              type="daterange"
              value-format="yyyy-MM-dd HH:hh:ss"
              unlink-panels
              range-separator="至"
              start-placeholder="开始日期"
              end-placeholder="结束日期"
              :picker-options="pickerOptions"
              @change="showRange"
            >
            </el-date-picker>
            <el-button @click="search" type="success">查询</el-button>
          </div>
          <!-- 借款列表容器 -->
          <div class="table-box">
            <el-tabs type="border-card" @tab-click="handleClick">
            <el-tab-pane
                v-for="(item, index) in playList"
                :key="index"
                :label="item"
              >
            <el-table
              :data="tableData"
              stripe
              style="width: 100%"
              :header-cell-style="{ background: '#e1e4e5' }"
            >
              <el-table-column prop="loanApplyId" label="借款编号" min-width="1">
              </el-table-column>
              <el-table-column prop="name" label="借款人" min-width="1">
              </el-table-column>
              <el-table-column prop="applyTime" label="申请时间" min-width="2">
              </el-table-column>
              <el-table-column prop="amount" label="借款金额" min-width="1">
              </el-table-column>
              <el-table-column prop="duration" label="借款期限(月)" min-width="1">
              </el-table-column>
              <el-table-column prop="loanRate" label="借款利率" min-width="1">
              </el-table-column>
              <el-table-column prop="repayDay" label="还款日" min-width="1">
              </el-table-column>
              <el-table-column
                prop="status"
                label="状态"
                min-width="1"
                :formatter="stateFormat"
              >
              </el-table-column>
              <el-table-column label="操作" min-width="1">
                <template slot-scope="scope">
                  <!-- Element Ui Popconfirm 气泡确认框 -->
                  <el-popconfirm
                    confirm-button-text="通过"
                    cancel-button-text="驳回"
                    confirm-button-type="success"
                    @onConfirm="agree(scope.row.loanApplyId)"
                    @onCancel="veto(scope.row.loanApplyId)"
                    icon="el-icon-info"
                    icon-color="red"
                    title="是否通过审核？"
                    :ref="`popover-${scope.$index}`"
                  >
                    <el-button
                      slot="reference"
                      type="primary"
                      size="small"
                      :disabled="checkDisable(scope.row.status)"
                      >审批</el-button
                    >
                  </el-popconfirm>
                </template>
              </el-table-column>
            </el-table>
            </el-tab-pane>
            </el-tabs>
          </div>
          <el-pagination background layout="prev, pager, next"
          :page-size=filterRange.perPage
          :current-page=filterRange.curPage
          :page-count=totalPages
          @current-change='onPageChange'
          >
          
          </el-pagination>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import { mapActions } from "vuex";
  export default {
    data() {
      return {
        playList: ["未审批", "已审批"],    // 表格的2个标签页
        pickerOptions: {
          shortcuts: [
            {
              text: "最近一周",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
                picker.$emit("pick", [start, end]);
              },
            },
            {
              text: "最近一个月",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
                picker.$emit("pick", [start, end]);
              },
            },
            {
              text: "最近三个月",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
                picker.$emit("pick", [start, end]);
              },
            },
          ],
        },
        dateValue: null,
        totalPages: 1,
        filterRange: {
          start: "",
          end: "",
          curPage: 1,
          perPage: 3,
          approve_status:0     // 筛选分类 0 未审批 1 已审批
        },
        tableData: [],
      };
    },
    methods: {
      ...mapActions({ getApplyList: "loan/getloanApplyList", updateApply:"loan/updateloanApply"}), // 获取借款申请列表 // 更新借款状态审批状态
      getLoanList() {
        this.getApplyList(this.filterRange)
          .then((data) => {
            if (data) {
              this.tableData = data.content;
              this.totalPages = data.paginateInfo.pages
            }
          })
          .catch(() => {});
      },
      // 切换标签 设置筛选分类
      handleClick(tab, event){
        this.filterRange.approve_status = parseInt(tab.index)
        this.getLoanList()
      },
      // 更改页码，重新获取借款列表
      onPageChange(val){
        this.filterRange.curPage = val
        this.getLoanList()
      },
      // 设置审批按钮状态 除未审批外都禁用
      checkDisable(type) {
        return type ? true : false;
      },
      // 审批通过 状态值 1 
      agree(id) {
        this.updateApplyState(id, 1);
      },
      // 审批驳回 状态值 2 
      veto(id) {
        this.updateApplyState(id, 2);
      },
      // 更新借款的审批状态
      updateApplyState(id, status) {
        const apply = { applyId: id, status: status };
        this.updateApply(apply).then(() => {
            this.getLoanList();
          })
          .catch(() => {});
      },
      // 日期组件值发生变化 更新日期范围
      showRange() {
        if (this.dateValue) {
          this.filterRange.start = this.dateValue[0];
          this.filterRange.end = this.dateValue[1];
        } else {
          this.filterRange.start = "";
          this.filterRange.end = "";
        }
      },
      // 格式化借款的审批状态
      stateFormat(row, column) {
        if (row.status === 0) {
          return "待审批";
        } else if (row.status === 1) {
          return "已通过";
        } else if (row.status === 2) {
          return "驳回";
        }
      },
      // 点击查询按钮 默认查询第一页
      search() {
        this.filterRange.curPage = 1
        this.getLoanList()
      },
    },
    computed: {},
    created() {
      this.getLoanList();
    },
  };
  </script>
  
  <style lang="scss" scoped>
  .loan-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .banner_title {
      padding-right: 15px;
    }
  
    .el-date-editor {
      margin: 0 10px;
    }
  
    .table-box {
      margin: 12px 0;
    }
  }
  </style>
  
  
  
  ```

#### 8.2 我的借款

> 我的借款页面显示当前登录用户所有的借款申请记录(审核状态，匹配状态，还款计划等)
>
> 审批未通过和未匹配状态下，还款计划为禁用状态。审批通过并且完全匹配后，还款周期开始了，还款计划可用。

![1632376605854](image\5C1632376605854.png)

![1632379051365](image\5C1632379051365.png)

---

- 先创建组件，views下创建loan文件夹，下面创建repayment.vue

![1632377518981](image\5C1632377518981.png)

- 配置路由

  > src-router-index.js

  ![1632377570456](image\5C1632377570456.png)

---

- 编写页面

  先添加获取我的借款列表，还款计划，债权还款的API和方法

  ![1632378188354](image\5C1632378188354.png)

  ![1632378251316](image\5C1632378251316.png)

  repayment.vue文件

  ```vue
  <template>
    <div class="repayMent-container">
      <el-card class="box-card">
        <div slot="header" class="card-title">
          <span>我的借款</span>
        </div>
        <div class="body-box">
          <!-- 我的借款容器 -->
          <div class="table-box">
            <el-table
              :data="tableData"
              stripe
              style="width: 100%"
              :header-cell-style="{ background: '#e1e4e5' }"
              :row-class-name="tableRowClassName"
            >
              <el-table-column prop="amount" label="借款金额" min-width="1">
              </el-table-column>
              <el-table-column prop="applyTime" label="申请时间" min-width="2">
              </el-table-column>
              <el-table-column prop="duration" label="借款期限(月)" min-width="1">
              </el-table-column>
              <el-table-column prop="loanRate" label="借款利率" min-width="1">
              </el-table-column>
  
              <el-table-column
                prop="status"
                label="审核状态"
                min-width="1"
                :formatter="stateFormat"
              >
              </el-table-column>
              <el-table-column
                prop="debt_match_status"
                label="匹配状态"
                min-width="1"
                :formatter="matchStateFormat"
              >
              </el-table-column>
              <el-table-column label="操作" min-width="1">
                <template slot-scope="myLoanScope">
                  <el-button
                    type="success"
                    size="small"
                    :disabled="checkDisable(myLoanScope.row.debt_match_status)"
                    @click="onRepayPlan(myLoanScope.row.debt_id)"
                    >还款计划</el-button
                  >
                </template>
              </el-table-column>
            </el-table>
          </div>
          <el-pagination
            background
            layout="prev, pager, next"
            :page-size="filterRange.perPage"
            :current-page="filterRange.curPage"
            :page-count="totalPages"
            @current-change="onPageChange"
          >
          </el-pagination>
          <!-- 还款计划的弹出框 -->
          <el-dialog
            class="msg-dialog"
            title="还款计划"
            :visible.sync="dialogTableVisible"
            width="33%"
          >
            <el-card class="message-card">
              <div class="repay-box">
                <el-table :data="repayData" style="width: 100%">
                  <el-table-column prop="currentTerm" label="当前期">
                  </el-table-column>
                  <el-table-column prop="receivableDate" label="还款日期">
                  </el-table-column>
                  <el-table-column prop="receivableMoney" label="还款金额">
                  </el-table-column>
                  <el-table-column
                    prop="isReturned"
                    :formatter="repayStateFormat"
                    label="还款状态"
                  >
                  </el-table-column>
                  <el-table-column label="操作">
                    <template slot-scope="repayScope">
                      <el-button
                        type="success"
                        size="small"
                        :disabled="checkRepayDisable(repayScope.row.isReturned)"
                        @click="onRepay(repayScope.row)"
                        >还款</el-button
                      >
                    </template>
                  </el-table-column>
                </el-table>
              </div>
            </el-card>
            <!-- 还款确认的弹出框 -->
            <el-dialog
              title="还款确认"
              :visible.sync="sonDialogVisible"
              width="20%"
              append-to-body
            >
              <span
                >还款金额为：{{
                  repayDetail.repayAmount
                }}，即将从账户余额还款</span
              >
              <span slot="footer" class="dialog-footer">
                <el-button @click="sonDialogVisible = false">取 消</el-button>
                <el-button type="primary" @click="onSubmit">确认还款</el-button>
              </span>
            </el-dialog>
          </el-dialog>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import { mapActions } from "vuex";
  export default {
    data() {
      return {
        totalPages: 1,
        dialogTableVisible: false,    // 还款计划显示控制对象
        sonDialogVisible: false,      // 还款确认显示控制对象
        filterRange: {
          curPage: 1,
          perPage: 3,
        },
        tableData: [],  // 我的借款表格数据源
        repayData: [],   // 还款计划表格数据源
        repayDetail: {    // 还款计划详情 金额 id
          repayAmount: 0,
          repay_id: "",
        },
        debtId: {},   // 债权ID
      };
    },
    methods: {
      ...mapActions({
        getMyLoanList: "loan/getMyloanList",                // 我的借款列表
        getRepayPlanList: "transaction/getRepayPlanList",   // 还款计划
        debtRepay: "transaction/debtRepay",                 // 债权还款
      }), // 获取借款申请列表
      getLoanList() {
        this.getMyLoanList(this.filterRange)
          .then((data) => {
            if (data) {
              this.tableData = data.content;
              this.totalPages = data.paginateInfo.pages;
            }
          })
          .catch(() => {});
      },
      onSubmit() {
        this.debtToRepay();
      },
      getRepayList() {   // 获取还款计划
        this.getRepayPlanList(this.debtId)
          .then((data) => {
            if (data) {
              this.repayData = data.data;
            }
          })
          .catch(() => {});
      },
      // 债权还款
      debtToRepay() {
        this.debtRepay(this.repayDetail)
          .then((data) => {
            if (data) {
              this.$message({
                message: "还款成功成功",
                type: "success",
              });
              this.sonDialogVisible = false;
              this.getRepayList();
            }
          })
          .catch(() => {});
      },
      // 点击了还款计划 根据借款对应的债权id查询还款计划
      onRepayPlan(id) {
        this.dialogTableVisible = true;
        this.debtId = { debt_id: id };
        this.getRepayList();
      },
      // 点击了还款计划里某一期的还款
      onRepay(row) {
        this.sonDialogVisible = true;
        this.repayDetail.repayAmount = row.receivableMoney;
        this.repayDetail.repay_id = row.id;
      },
      onPageChange(val) {
        this.filterRange.curPage = val;
        this.getLoanList();
      },
      // 还款计划按钮状态 （非 完全匹配的 还款计划操作禁用）
      checkDisable(type) {
        return type != 2 ? true : false;
      },
      // 已还款的 禁用操作
      checkRepayDisable(type) {
        return type ? true : false;
      },
      tableRowClassName({ row, rowIndex }) {
        row.index = rowIndex;
      },
      // 格式化审批状态
      stateFormat(row, column) {
        if (row.status === 0) {
          return "待审批";
        } else if (row.status === 1) {
          return "已通过";
        } else if (row.status === 2) {
          return "驳回";
        }
      },
      // 格式化 匹配状态
      matchStateFormat(row, column) {
        if (row.debt_match_status === 0) {
          return "未匹配";
        } else if (row.debt_match_status === 1) {
          return "部分匹配";
        } else if (row.debt_match_status === 2) {
          return "完全匹配";
        }
      },
      // 格式化还款计划里的还款状态
      repayStateFormat(row, column) {
        if (row.isReturned === 0) {
          return "未还款";
        } else if (row.isReturned === 1) {
          return "已还款";
        }
      },
    },
    computed: {},
    created() {
      this.getLoanList();
    },
  };
  </script>
  
  <style lang="scss" scoped>
  .repayMent-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .banner_title {
      padding-right: 15px;
    }
  
    .el-date-editor {
      margin: 0 10px;
    }
  
    .table-box {
      margin: 12px 0;
    }
  }
  </style>
  ```


### 9. 债权管理

> 债权管理页面展示所有的 通过审批的借款 生成的债权，债权的匹配状态，匹配金额等。

![1632380962406](image\5C1632380962406.png)

---

- 先创建组件，views下创建debt文件夹，下面创建index.vue

![1632381375554](image\5C1632381375554.png)

- 配置路由

  > src-router-index.js

  ![1632381441618](image\5C1632381441618.png)

---

- 编写页面

  先添加请求债权列表的API和方法

  ![1632382141602](image\5C1632382141602.png)

  ![1632382344114](image\5C1632382344114.png)

  index.vue文件

  ```vue
  <template>
    <div class="debt-container">
      <el-card class="box-card">
        <div slot="header" class="card-title">
          <span>债权管理</span>
        </div>
        <div class="body-box">
          <!-- 日期选择容器 -->
          <div class="date-selecter">
            <span class="banner_title">日期选择</span>
            <span class="demonstration">选择日期</span>
            <el-date-picker
              v-model="value2"
              type="daterange"
              value-format="yyyy-MM-dd HH:hh:ss"
              unlink-panels
              range-separator="至"
              start-placeholder="开始日期"
              end-placeholder="结束日期"
              :picker-options="pickerOptions"
              @change="showRange"
            >
            </el-date-picker>
            <el-button @click="search" type="success">查询</el-button>
          </div>
          <!-- 投资计划容器 -->
          <div class="table-box">
            <el-table
              :data="tableData"
              stripe
              style="width: 100%"
              :header-cell-style="{ background: '#e1e4e5' }"
            >
              <el-table-column prop="debtNo" label="债权编号" min-width="1">
              </el-table-column>
              <el-table-column prop="loanNo" label="合同编号" min-width="1">
              </el-table-column>
              <el-table-column
                prop="loanStartDate"
                label="债权转入日期"
                min-width="2"
              >
              </el-table-column>
              <el-table-column prop="repaymenDate" label="还款日" min-width="1">
              </el-table-column>
              <el-table-column
                prop="debtYearRate"
                label="债权月利率"
                min-width="1"
              >
              </el-table-column>
              <el-table-column
                prop="debtMoney"
                label="债权转入金额"
                min-width="1"
              >
              </el-table-column>
              <el-table-column prop="name" label="每月还款金额" min-width="1">
              </el-table-column>
              <el-table-column prop="matchedMoney" label="债权已匹配金额" min-width="1">
              </el-table-column>
              <el-table-column prop="debtStatus" label="债权状态" min-width="1">
              </el-table-column>
              <el-table-column
                prop="matchedStatus"
                :formatter="stateFormat"
                label="债权已匹配状态"
                min-width="1"
              >
              </el-table-column>
              <el-table-column label="操作" min-width="1">
                <el-button type="primary" size="mini">详情</el-button>
              </el-table-column>
            </el-table>
          </div>
          <el-pagination
            background
            layout="prev, pager, next"
            :page-size="filterRange.perPage"
            :current-page="filterRange.curPage"
            :page-count="totalPages"
            @current-change="onPageChange"
          >
          </el-pagination>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import { mapActions } from "vuex";
  export default {
    data() {
      return {
        pickerOptions: {
          shortcuts: [
            {
              text: "最近一周",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
                picker.$emit("pick", [start, end]);
              },
            },
            {
              text: "最近一个月",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
                picker.$emit("pick", [start, end]);
              },
            },
            {
              text: "最近三个月",
              onClick(picker) {
                const end = new Date();
                const start = new Date();
                start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
                picker.$emit("pick", [start, end]);
              },
            },
          ],
        },
        value1: "",
        value2: null,
        totalPages: 1,
        filterRange: {
          start: "",
          end: "",
          curPage: 1,
          perPage: 3,
        },
        tableData: [],
      };
    },
    methods: {
      ...mapActions({ getList: "loan/getDebtList" }), // 获取债权列表
      getDebtList() {
        this.getList(this.filterRange)
          .then((data) => {
            if (data) {
              this.tableData = data.content;
              this.totalPages = data.paginateInfo.pages;
            }
          })
          .catch(() => {});
      },
      showRange() {
        if (this.value2) {
          this.filterRange.start = this.value2[0];
          this.filterRange.end = this.value2[1];
        } else {
          this.filterRange.start = "";
          this.filterRange.end = "";
        }
      },
      stateFormat(row, column) {
        if (row.matchedStatus === 0) {
          return '未匹配'
        } else if (row.matchedStatus === 1) {
          return '部分匹配'
        } else if (row.matchedStatus === 2) {
          return '已匹配';
        }
      },
      search() {
        this.filterRange.curPage = 1;
        this.getDebtList();
      },
      onPageChange(val) {
        this.filterRange.curPage = val;
        this.getDebtList();
      },
    },
    computed: {},
    created() {
      this.getDebtList();
    },
  };
  </script>
  
  <style lang="scss" scoped>
  .debt-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .banner_title {
      padding-right: 15px;
    }
  
    .el-date-editor {
      margin: 0 10px;
    }
  
    .table-box {
      margin-top: 12px;
    }
  }
  </style>
  
  
  
  ```


### 10. 产品管理

> 产品管理页面显示平台所有投资计划

![1632382663339](image\5C1632382663339.png)

---

- 先创建组件，views下创建productManage文件夹，下面创建index.vue

![1632382742411](image\5C1632382742411.png)

- 配置路由

  > src-router-index.js

  ![1632382844371](image\5C1632382844371.png)

  ---

- 编写页面

  先添加请求产品列表的API和方法

  ![1632382970591](image\5C1632382970591.png)

  ![1632383016315](image\5C1632383016315.png)

  index.vue文件

  ```vue
  <template>
    <div class="product-container">
      <el-card class="box-card">
        <div slot="header" class="card-title">
          <span>产品管理</span>
        </div>
        <div class="body-box">
          <!-- 投资计划容器 -->
          <div class="table-box">
            <el-table
              :data="tableData"
              stripe
              style="width: 100%"
              :header-cell-style="{ background: '#e1e4e5' }"
            >
              <el-table-column prop="id" label="序号" min-width="1">
              </el-table-column>
              <el-table-column prop="proNum" label="产品编号" min-width="1">
              </el-table-column>
              <el-table-column prop="productName" label="产品名称" min-width="1">
              </el-table-column>
              <el-table-column prop="minLimit" label="最小期" min-width="1">
              </el-table-column>
              <el-table-column prop="maxLimit" label="最大期" min-width="1">
              </el-table-column>
              <el-table-column prop="earning" label="年化利率" min-width="1">
              </el-table-column>
              <el-table-column prop="ReturnMoney" label="回款方式" min-width="2">
              </el-table-column>
              <el-table-column prop="closedPeriod" label="封闭期" min-width="1">
              </el-table-column>
              <el-table-column prop="status" label="状态" 
              :formatter="stateFormat"
              min-width="1">
              </el-table-column>
              <el-table-column label="操作" min-width="1">
                <el-button disabled type="primary" size="small">管理</el-button>
              </el-table-column>
            </el-table>
          </div>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import { mapActions } from "vuex";
  import {
    provinceAndCityData,
    CodeToText,
    TextToCode,
  } from "element-china-area-data";
  export default {
    data() {
      return {
        value1: "",
  
        dateRange: {
          start: "",
          end: "",
        },
        tableData: [],
      };
    },
    methods: {
      ...mapActions({ getProList: "invest/getProductList" }), // 获取产品列表
      showAreaText(row, column) {
        return CodeToText[row.area];
      },
      stateFormat(row, column) {
        if (row.status === 0) {
          return "未开放";
        } else if (row.status === 1) {
          return "正常";
        }
      },
    },
    computed: {},
    created() {
      this.getProList()
        .then((data) => {
          if (data) {
            this.tableData = data;
          }
        })
        .catch(() => {});
    },
  };
  </script>
  
  <style lang="scss" scoped>
  .product-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .banner_title {
      padding-right: 15px;
    }
  
    .el-date-editor {
      margin: 0 10px;
    }
  
    .table-box {
      margin-top: 12px;
    }
  }
  </style>
  ```

### 11. 消息管理

#### 11.1 消息群发

> 消息群发可以方便的分组给对应身份组的用户发送系统短消息

![1632384127353](image\5C1632384127353.png)

---

- 先创建组件，views下创建message文件夹，下面创建msgManage.vue

![1632384588537](image\5C1632384588537.png)

- 配置路由

  > src-router-index.js

  ![1632384722630](image\5C1632384722630.png)

  ---

- 编写页面

  先添加发送消息的API和方法

  ![1632385117850](image\5C1632385117850.png)

  ![1632385314472](image\5C1632385314472.png)

  msgManage.vue文件

  ```vue
  <template>
    <div class="msgManage-container">
      <el-card class="box-card">
        <div slot="header" class="card-title">
          <span>消息群发</span>
        </div>
        <div class="body-box">
          <el-form
            ref="newMsgForm"
            :model="newMsgForm"
            :rules="msgRules"
            label-width="80px"
          >
            <el-form-item label="消息标题" prop="title">
              <el-input
                class="msg-title"
                maxlength="15"
                show-word-limit
                v-model="newMsgForm.title"
              ></el-input>
            </el-form-item>
            <el-form-item label="接收组" prop="group">
              <el-select v-model="newMsgForm.group" class="groups">
                <el-option label="用户组" value=0></el-option>
                <el-option label="管理组" value=1></el-option>
                <el-option label="全体用户" value=2></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="消息内容" prop="content">
              <el-input
                type="textarea"
                class="msgContent"
                v-model="newMsgForm.content"
                maxlength="200"
                show-word-limit
                rows = 4
              ></el-input>
            </el-form-item>
            <el-form-item class="bottom-btn">
              <el-button type="primary" @click="onSubmit('newMsgForm')"
                >立即发送</el-button
              >
              <el-button>取消</el-button>
            </el-form-item>
          </el-form>
        </div>
      </el-card>
    </div>
  </template>
  
  <script>
  import { mapActions } from "vuex";
  export default {
    data() {
      return {
        newMsgForm: {
          title: "",
          group: "",
          content: "",
        },
        msgRules: {
          title: [{ required: true, message: "请输入标题", trigger: "blur" }],
          group: [{ required: true, message: "请选择接收组", trigger: "blur" }],
          content: [
            {
              required: true,
              min: 6,
              max: 200,
              message: "请输入最少6个字符",
              trigger: "blur",
            },
          ],
        },
      };
    },
    methods: {
      ...mapActions({ messageSend: "message/messageSend" }), // 发送短消息
      onSubmit(formName) {
        this.$refs[formName].validate((valid) => {
          if (valid) {
            this.$store
              .dispatch("message/messageSend", this.newMsgForm)
              .then(() => {
                this.$message({
                  message: "发送成功",
                  type: "success",
                });
                this.$refs[formName].resetFields();
              })
              .catch(() => {});
          }
        });
      },
      resetForm(formName) {
        this.$refs[formName].resetFields();
      },
    },
    computed: {},
    created() {
    },
  };
  </script>
  
  <style lang="scss" scoped>
  .msgManage-container {
    margin: 50px auto;
    max-width: 1000px;
  
    .bottom-btn {
      margin-top: 20px;
    }
  
    .groups{
      width: 120px;
    }
  
    .msg-title {
      max-width: 33%;
      min-width: 15%;
    }
  
    .card-title {
      font-size: 22px;
      color: #409eff;
    }
  
    .banner_title {
      padding-right: 15px;
    }
  
    .el-date-editor {
      margin: 0 10px;
    }
  
    .table-box {
      margin-top: 12px;
    }
  }
  </style>
  
  
  ```


#### 11.2 我的消息

> 我的消息页面展示当前登录用户收到的所有信息（标题，发送时间，已读状态）

![1632385694568](image\5C1632385694568.png)

---

- 先创建组件，message下创建msgManage.vue

![1632386567096](image\5C1632386567096.png)

- 配置路由

  > src-router-index.js

  ![1632387253587](image\5C1632387253587.png)

  ---

- 编写页面

  先添加获取消息列表，查看消息，删除消息的API和方法

  ![1632392645670](image\5C1632392645670.png)

  ![1632392770926](image\5C1632392770926.png)



  myMessage.vue文件

```
<template>
  <div class="message-container">
    <el-card class="box-card">
      <div slot="header" class="card-title">
        <span>消息</span>
      </div>
      <div class="body-box">
        <div class="table-box">
          <el-table
            :data="tableData"
            stripe
            style="width: 100%"
            :header-cell-style="{ background: '#e1e4e5' }"
          >
            <el-table-column prop="sendName" label="寄信人" min-width="1">
            </el-table-column>
            <el-table-column prop="title" label="标题" min-width="3">
            </el-table-column>
            <el-table-column prop="sendTime" label="发送时间" min-width="2">
            </el-table-column>
            <el-table-column
              prop="state"
              :formatter="stateFormat"
              label="状态"
              min-width="1"
            >
            </el-table-column>
            <el-table-column label="操作" min-width="2">
              <template slot-scope="scope">
                <el-button
                  size="mini"
                  @click="check(scope.row)"
                  type="success"
                  plain
                  >查看</el-button
                >
                <el-button
                  size="mini"
                  @click="deleteMsg(scope.row)"
                  type="danger"
                  plain
                  >删除</el-button
                >
              </template>
            </el-table-column>
          </el-table>
          <!-- 消息查看对话框 -->
          <el-dialog
            class="msg-dialog"
            :title="msg_info.title"
            :visible.sync="dialogTableVisible"
            width="33%"
          >
            <el-card class="message-card">
              <div slot="header" class="clearfix">
                <span>发件人:</span>
                <span>{{ msg_info.sendName }}</span>
              </div>
              <div class="text item">
                {{ msg_info.content }}
              </div>
            </el-card>
          </el-dialog>
        </div>
        <!-- 分页 -->
        <el-pagination
          background
          layout="prev, pager, next"
          :page-size="pageRange.perPage"
          :current-page="pageRange.curPage"
          :page-count="totalPages"
          @current-change="onPageChange"
        >
        </el-pagination>
      </div>
    </el-card>
  </div>
</template>

<script>
import { mapActions } from "vuex";
export default {
  data() {
    return {
      totalPages: 1,
      pageRange: {
        curPage: 1,
        perPage: 3,
      },
      tableData: [],
      dialogTableVisible: false,
      msg_info: {
        title: "",
        sendName: "",
        content: "",
      },
    };
  },
  methods: {
    ...mapActions({
      checkMsg: "message/checkMessages",   // 查看单条消息详情
      getMessages: "message/getMessages",  // 获取消息列表
      delMessages: "message/delMessages",  // 删除消息
    }), // 获取消息列表
    check(row) {
      this.msg_info.title = row.title;
      this.msg_info.content = row.detail;
      this.msg_info.sendName = row.sendName;
      // 是否已读
      if (row.state) {
        this.dialogTableVisible = true;
      } else {
        const msgId = {
          message_id: row.id,
        };
        // 未读的话 更新一下消息的已读状态
        this.checkMsg(msgId)
          .then((data) => {
            if (data) {
              this.get_messages();
              this.dialogTableVisible = true;
            }
          })
          .catch(() => {});
      }
    },
    // 删除消息
    deleteMsg(row) {
      const msgId = {
        message_id: row.id,
      };
      this.delMessages(msgId)
        .then((data) => {
          if (data) {
            this.get_messages();
          }
        })
        .catch(() => {});
    },
    // 获取消息列表
    get_messages() {
      this.getMessages(this.pageRange)
        .then((data) => {
          if (data) {
            this.tableData = data.content;
            this.totalPages = data.paginateInfo.pages;
          }
        })
        .catch(() => {});
    },
    onPageChange(val) {
      this.pageRange.curPage = val;
      this.get_messages();
    },
    // 格式化已读状态
    stateFormat(row, column) {
      if (row.state === 0) {
        return "未读";
      } else {
        return "已读";
      }
    },
  },
  computed: {},
  created() {
    this.get_messages();
  },
};
</script>

<style>
  .msg-dialog .el-dialog__body {
        padding: 10px;
    }
</style>

<style lang="scss" scoped>
.message-container {
  margin: 50px auto;
  max-width: 1000px;

  .message-card {
    width: 100%;
    min-height: 200px;

    
  }

  .card-title {
    font-size: 22px;
    color: #409eff;
  }

  .banner_title {
    padding-right: 15px;
  }

  .el-date-editor {
    margin: 0 10px;
  }

  .table-box {
    margin-top: 12px;
  }
}
</style>


```

### 12. 账号设置

#### 12.1 安全设置

> 安全设置显示用户的相关状态信息，并根据是否认证显示不同的标识，并可以进行不同的操作。

![1626071103767](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626071103767.png)

------

先创建 安全设置组件，views下创建account文件夹，下面创建safe.vue

![1626069350983](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626069350983.png)

配置路由

将上面路由中安全设置对应的组件 修改为 

![1626069510196](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626069510196.png)

在safe.vue中先写入一个空白的template，放入一个div,保存

我们点击左侧菜单栏账号设置下面的安全设置，成功跳转到页面

![1626070139148](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626070139148.png)

------

下面编写页面

- 先添加组件里要用到的，请求实名认证和设置支付密码,修改登录密码的方法

![1626072485986](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626072485986.png)

```javascript
// 设置支付密码
export function setPayPwd(data) {
  return request({
    url: '/user/payPwd',
    method: 'post',
    data: data
  })
}

// 实名认证
export function realNameAuth(data) {
  return request({
    url: '/user/realName',
    method: 'post',
    data: data
  })
}
```

action里面导入刚刚创建的api请求并使用。

![1626074929336](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626074265892.png)

```
setPayPwd, realNameAuth

SET_PAYPWD: (state, status) => {
    state.accountStatus.payPwdStatus = 1
  },
  SET_REALNAME: (state, status) => {
    state.accountStatus.realNameAuth = 1
  },
```

![1626075112243](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626074330365.png)

```
setPayPwd({commit}, data){
    return new Promise(resolve => {
      setPayPwd(data).then((response) => {
        console.log('设置支付密码成功')
        commit('SET_PAYPWD')
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },

  realNameAuth({commit}, data){
    return new Promise(resolve => {
      realNameAuth(data).then((response) => {
        console.log('实名认证成功')
        commit('SET_REALNAME')
        resolve()
      }).catch(error => {
        reject(error)
      })
    })
  },

```



------

- 下面是组件里面的内容

```vue
<template>
  <div class="safe-container">
    <!-- 安全设置 卡片容器 -->
    <el-card class="box-card">
      <div class="setting-box">
        <!-- 表单组件 -->
        <el-table
          :data="tableData"
          style="width: 100%"
        >
          <el-table-column prop="safeType" label="安全设置" width="80">
          </el-table-column>
          <el-table-column prop="status" width="80">
            <template slot-scope="scope">
              <!-- 根据这行的值来设置 是否应用样式 -->
              <div :class="{ statusSuccess: scope.row.status }">
                <i class="el-icon-success"></i>
              </div>
            </template>
          </el-table-column>
          <!-- formatter 格式化内容 -->
          <el-table-column
            prop="value"
            :formatter="stateFormat"
            max-width="480"
          >
          </el-table-column>
          <el-table-column width="120">
            <template slot-scope="scopeBtn">
              <!-- 根据不同的安全类型和值 设置不同的按钮 -->
              <el-button
                type="text"
                v-if="checkStatus(scopeBtn.row) == '认证成功'"
              >
                认证成功
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '去认证'"
                @click="authAccount"
              >
                去认证
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '更换手机号'"
                @click="changePhone"
              >
                更换手机号
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '修改'"
                @click="changeLoginPwd"
              >
                修改
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '重置'"
                @click="changePayPwd"
              >
                重置
              </el-button>
              <el-button
                type="text"
                v-else-if="checkStatus(scopeBtn.row) == '去设置'"
                @click="setPayPwd"
              >
                去设置
              </el-button>
            </template>
          </el-table-column>
        </el-table>
      </div>
    </el-card>
    <!-- 设置支付密码的对话框 -->
    <el-dialog
      title="设置支付密码"
      :visible.sync="payPwdDialogVisible"
      width="30%"
      center
    >
      <el-form
        ref="ruleForm"
        :rules="rules"
        :model="ruleForm"
        label-width="80px"
      >
        <el-form-item label="支付密码" prop="password">
          <el-input
            type="password"
            v-model="ruleForm.password"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="确认密码" prop="checkPass">
          <el-input
            type="password"
            v-model="ruleForm.checkPass"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="onSubmit('ruleForm')"
            >确认</el-button
          >
          <el-button @click="onCancel('ruleForm')">取消</el-button>
        </el-form-item>
      </el-form>
    </el-dialog>
    <!-- 实名认证的对话框 -->
    <el-dialog
      title="实名认证"
      :visible.sync="realNameDialogVisible"
      width="30%"
      center
    >
      <el-form
        ref="realNameForm"
        :rules="realNameRules"
        :model="realNameForm"
        label-width="80px"
      >
        <el-form-item label="姓名" label-width="100px" prop="realName">
          <el-input
            maxLength="10"
            v-model="realNameForm.realName"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="身份证号码" label-width="100px" prop="idNum">
          <el-input v-model="realNameForm.idNum" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="onRealNameSubmit('realNameForm')"
            >确认</el-button
          >
          <el-button @click="onCancel('realNameForm')">取消</el-button>
        </el-form-item>
      </el-form>
    </el-dialog>
  </div>
</template>

<script>
import { mapGetters, mapMutations, mapActions } from "vuex";
export default {
  methods: {
    // 实名验证表单提交
    onRealNameSubmit(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          console.log("通过验证");
          const data = {
            realName: this.realNameForm.realName,
            idNum: this.realNameForm.idNum,
          };
          // 调用 请求实名认证api的 方法
          this.$store
            .dispatch("user/realNameAuth", data)
            .then(() => {
              this.$message({
                message: "认证成功",
                type: "success",
              });
              this.onCancel(formName);
              this.setStatus();
            })
            .catch(() => {});
        } else {
          console.log("未通过验证");
        }
      });
    },
    // 设置支付密码表单提交
    onSubmit(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          console.log("通过验证");
          const data = { pwd: this.ruleForm.password };
          // 调用 请求设置支付密码api的 方法
          this.$store
            .dispatch("user/setPayPwd", data)
            .then(() => {
              this.$message({
                message: "设置成功",
                type: "success",
              });
              this.onCancel(formName);
              this.setStatus();
            })
            .catch(() => {});
        } else {
          console.log("未通过验证");
        }
      });
    },
    // 点击取消 隐藏窗口 重置表单
    onCancel(formName) {
      console.log("隐藏窗口");
      this.$refs[formName].resetFields();
      this.payPwdDialogVisible = false;
      this.realNameDialogVisible = false;
    },
    setStatus() {
      var cont = 0;
      for (var key in this.accountStatus) {
        this.tableData[cont].status = this.accountStatus[key];
        this.tableData[cont].value = this.accountStatus[key];
        cont++;
      }
    },
    stateFormat(row, column) {
      if (row.safeType === "用户名") {
        return row.value;
      } else if (row.safeType === "实名认证") {
        return row.status ? "已认证" : "未认证";
      } else if (row.safeType === "手机认证") {
        return row.status ? row.value : "未设置";
      } else if (row.safeType === "登录密码" || row.safeType === "支付密码") {
        return row.status ? "已设置" : "未设置";
      }
    },
    checkStatus(row) {
      if (row.safeType === "手机认证") {
        return "更换手机号";
      } else if (row.safeType === "实名认证") {
        if (row.value) {
          return "认证成功";
        } else {
          return "去认证";
        }
      } else if (row.safeType === "登录密码") {
        return "修改";
      } else if (row.safeType === "支付密码") {
        if (row.value) {
          return "重置";
        } else {
          return "去设置";
        }
      } else {
      }
    },
    authAccount() {
      console.log("认证账户");
      this.realNameDialogVisible = true;
    },
    changePhone() {
      console.log("修改手机");
    },
    changeLoginPwd() {
      console.log("修改登录密码");
    },
    changePayPwd() {
      console.log("修改支付密码");
    },
    setPayPwd() {
      console.log("设置支付密码");
      this.payPwdDialogVisible = true;
    },
  },
  data() {
    var validatePass = (rule, value, callback) => {
      if (value === "") {
        callback(new Error("请输入密码"));
      } else {
        if (this.ruleForm.checkPass !== "") {
          this.$refs.ruleForm.validateField("checkPass");
        }
        callback();
      }
    };
    var validatePass2 = (rule, value, callback) => {
      if (value === "") {
        callback(new Error("请再次输入密码"));
      } else if (value !== this.ruleForm.password) {
        callback(new Error("两次输入密码不一致!"));
      } else {
        callback();
      }
    };

    var validateName = (rule, value, callback) => {
      var reg = new RegExp("[\\u4E00-\\u9FFF]+$", "g");
      if (!reg.test(value)) {
        callback(new Error("不是纯中文字符"));
      } else {
        callback();
      }
    };

    var validateIdNum = (rule, value, callback) => {
      var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
      if (!reg.test(value)) {
        callback(new Error("身份证输入不合法"));
      } else {
        callback();
      }
    };
    return {
      payPwdDialogVisible: false,
      realNameDialogVisible: false,
      rules: {
        password: [
          { validator: validatePass, required: true, trigger: "blur" },
          {
            min: 6,
            max: 18,
            trigger: "blur",
            message: "密码6到18位之间",
          },
        ],
        checkPass: [
          { validator: validatePass2, required: true, trigger: "blur" },
        ],
      },
      realNameRules: {
        realName: [
          { validator: validateName, required: true, trigger: "blur" },
        ],
        idNum: [{ validator: validateIdNum, required: true, trigger: "blur" }],
      },
      tableData: [
        {
          safeType: "用户名",
          status: "",
          value: "",
        },
        {
          safeType: "实名认证",
          status: "",
          value: "",
        },
        {
          safeType: "手机认证",
          status: "",
          value: "",
        },
        {
          safeType: "登录密码",
          status: "",
          value: "",
        },
        {
          safeType: "支付密码",
          status: "",
          value: "",
        },
      ],
      ruleForm: {
        password: "",
        checkPass: "",
      },
      realNameForm: {
        realName: "",
        idNum: "",
      },
    };
  },
  computed: {
    ...mapGetters(["accountStatus"]),
  },
  created() {
    this.setStatus();
  },
};
</script>

<style lang="scss" scoped>
.safe-container {
  margin: 50px auto;
  max-width: 1000px;
}

.statusSuccess {
  color: lightgreen;
}

.status-fail {
  font-size: 20px;
  // color: lightgreen;
}

.text {
  font-size: 14px;
}

.item {
  padding: 18px 0;
}

.box-card {
  width: 80%;
  margin: 0px auto;
  .el-icon-success {
    font-size: 20px;
  }
}

</style>
```



#### 12.2 银行卡信息

> 管理用户的银行卡，可以添加，删除。点击编辑按钮，银行卡右上角会出现垃圾桶小图标，点击会弹出对话框是否确认删除，点击添加银行卡会弹出添加银行卡的对话框。

![1626076509298](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626076509298.png)

![1626076636016](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626076636016.png)

![1626076689625](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626076689625.png)

------

- 先创建 银行卡设置组件，views下account文件夹，下面创建safe.vue

  ![1626076884956](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626076884956.png)

  修改之前配置的路由

  > src-router-index.js

  ![1626077177086](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626077177086.png)

------

- 先添加组件里要用到的，请求 银行卡列表，添加和删除银行卡的方法

  ![1626077791851](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626077791851.png)

```javascript
export function addBankCard(data) {
  return request({
    url: '/card/card',
    method: 'post',
    data: data
  })
}

export function getBankCard() {
  return request({
    url: '/card/card',
    method: 'get',
  })
}

export function delBankCard(data) {
  return request({
    url: '/card/card',
    method: 'delete',
    data: data
  })
}
```

![1626078273845](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626078273845.png)

![1626078860778](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626078860778.png)

- 然后在getters里面添加 bankCardList

  ![1626079946439](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626079946439.png)

  ```
  
  ```

------

**<u>在写组件内代码前，我们先安装一个 省市区三级联动选择 的插件</u>**

> npm install element-china-area-data -S
>
> 实现效果如下
>
> ![1626080065363](D:/Chobit/doc/%E9%A9%AC%E5%A3%AB%E5%85%B5%E9%87%91%E8%9E%8D/%E5%89%8D%E7%AB%AF/image/5C1626080065363.png)

------

下面是vue文件内代码

```vue
<template>
  <div class="card-container">
    <el-card class="box-card">
      <!-- 卡片标题 -->
      <div slot="header" class="clearfix">
        <span>银行卡设置</span>
        >
      </div>
      <!-- v-if 根据用户是否有银行卡来显示 -->
      <div v-if="bankCardList.length" class="bankCardList">
        <!-- 编辑按钮 -->
        <el-checkbox class="edit-btn" v-model="isEdit">编辑</el-checkbox>
        <div class="card-box">
          <!-- 循环渲染 银行卡 -->
          <div
            v-for="(item, index) in bankCardList"
            :key="index"
            style="position: relative"
          >
             <el-button 
              class="delete-btn"
              type="danger"
              icon="el-icon-delete"
              circle
               v-if="isEdit"
               size="mini"
               @click="deleteCard(index)"
            ></el-button>
            <div class="card-info">
              <span>{{ item.bankName }}</span>
              <span>{{ item.cardNum }}</span>
            </div>

            <!-- <i class="el-icon-success isSelect" v-show="item.show"></i> -->
          </div>
        </div>
        <el-divider></el-divider>
      </div>
      <!-- 添加银行卡按钮的容器 -->
      <div class="newCard-Box">
        <div @click="addCardDialogVisible = true" class="addCard">
          <span><i class="el-icon-plus"></i></span>
          <span>添加银行卡</span>
        </div>
      </div>
      <el-dialog
        title="添加银行卡"
        :visible.sync="addCardDialogVisible"
        width="30%"
        center
      >
        <el-form ref="form" :rules="rules" :model="form" label-width="80px">
          <el-form-item label="持卡人" prop="holder">
            <el-input maxLength="10" v-model="form.holder"></el-input>
          </el-form-item>
          <el-form-item label="银行" prop="openingBank">
            <el-select
              v-model="form.openingBank"
              placeholder="请选择开户行"
              style="width: 100%"
            >
              <el-option label="中国银行" value="中国银行"></el-option>
              <el-option label="农业银行" value="农业银行"></el-option>
              <el-option label="工商银行" value="工商银行"></el-option>
              <el-option label="建设银行" value="建设银行"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="开户行" prop="bankBranch">
            <el-input maxLength="15" v-model="form.bankBranch"></el-input>
          </el-form-item>
          <el-form-item label="开户城市" prop="cityId">
            <el-cascader
              placeholder="请选择"
              style="width: 100%"
              size="large"
              :options="options"
              v-model="form.cityId"
              @change="handleChange"
            >
            </el-cascader>
          </el-form-item>
          <el-form-item label="卡号" prop="cardNum">
            <el-input maxLength="19" v-model="form.cardNum"></el-input>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="onSubmit('form')">添加</el-button>
            <el-button @click="onCancel('form')">取消</el-button>
          </el-form-item>
        </el-form>
      </el-dialog>
    </el-card>
  </div>
</template>

<script>
import { regionData} from "element-china-area-data";
import { mapGetters, mapMutations, mapActions } from "vuex";
export default {
  data() {
    // 银行卡号验证器
    const validatecardNum = (rule, value, callback) => {
      if (/\d{19}$/.test(value)) {
        callback();
      } else {
        callback(new Error("请输入19位银行卡号"));
      }
    };
    return {
      isEdit: false,    // 银行卡可编辑状态
      options: regionData,   // 城市地区数据
      addCardDialogVisible: false,    // 添加银行卡的对话框显示状态
      form: {
        holder: "",  // 持有人
        openingBank: "",    // 开户银行
        bankBranch: "",   // 银行支行
        cardNum: "",    // 银行卡号
        cityId: "",    // 地区编号
      },
      //  表单验证对象
      rules: {
        holder: [{ required: true }, { trigger: "blur" }],
        openingBank: [{ required: true }, { trigger: ["blur", "change"] }],
        bankBranch: [{ required: true }, { trigger: "blur" }],
        cityId: [{ required: true }, { trigger: ["blur", "change"] }],
        cardNum: [
          { required: true },
          { validator: validatecardNum, trigger: "blur" },
        ],
      },
    };
  },
  methods: {
    ...mapActions({ getBankCardList: "user/getBankCard" }),  // 获取银行卡
    //  隐藏添加银行卡的窗口 重置表单
    onCancel(formName) {
      console.log("隐藏窗口");
      console.log("formName:", formName);
      this.$refs[formName].resetFields();
      this.addCardDialogVisible = false;
    },
    onSubmit(formName) {
      this.$refs[formName].validate((valid) => {
        if (valid) {
          console.log("通过了验证");
          this.$store
            .dispatch("user/addBankCard", this.form)
            .then(() => {
              console.log("添加银行卡成功");
              this.$message({
                message: "添加银行卡成功",
                type: "success",
              });
              this.getBankCardList();
              this.onCancel("form");
            })
            .catch(() => {});
        } else {
        }
      });
    },
    handleChange(arr) {
      this.form.cityId = arr[2];
      console.log(this.form.cityId);
    },
    deleteCard(index){
      this.$confirm('确认删除？','提示', {
          confirmButtonText: '删除',
          cancelButtonText: '取消',
          type: 'warning'
        })
          .then(_ => {
            console.log('删除',index,'银行卡')
            const del_card = {'cardNum': this.bankCardList[index].cardNum}
            this.$store
            .dispatch("user/delBankCard", del_card)
            .then(() => {
              console.log("删除银行卡成功");
              this.$message({
                message: "删除银行卡成功",
                type: "success",
              });
              this.getBankCardList();
            })
            .catch(() => {});
          })
          .catch(_ => {
            console.log('取消了')
          });
    }
  },
  created() {
    this.getBankCardList();
  },
  computed: {
    ...mapGetters(["bankCardList"]),
  },
};
</script>

<style lang="scss" scoped>
.card-container {
  margin: 50px auto;
  max-width: 1000px;
}

.text {
  font-size: 14px;
}

.bankCardList {
  position: relative;
}

.item {
  margin-bottom: 18px;
}

.edit-btn {
  position: absolute;
  right: 5px;
  top: -15px;
}

.card-box {
  display: flex;
  flex-wrap: wrap;

  .delete-btn {
    position: absolute;
    right: 24px;
    top: 14px;
  }
}

.clearfix:before,
.clearfix:after {
  display: table;
  content: "";
}
.clearfix:after {
  clear: both;
}

.box-card {
  width: 100%;
}

.addCard {
  margin-left: 18px;
  width: 200px;
  height: 120px;
  background-color: #67C23A;
  border-radius: 6%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.card-info {
  background-color: rgb(206, 223, 255);
  border-radius: 6%;
  width: 200px;
  height: 120px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 8px 19px;
}

</style>
```

### 13.动态路由

> (按登录用户的身份不同，加载不同的路由，实现操作菜单的不同)
>
> 下面是**管理员**登录，个人中心的操作菜单
>
> ![1632460031722](image\5C1632460031722.png)
>
> 下面是**普通用户**登录，个人中心的操作菜单
>
> ![1632460096958](image\5C1632460096958.png)

- 修改路由守卫内容

  ![1632461113924](image\5C1632461113924.png)

  ```javascript
  if (hasToken) {
      if (to.path === '/login') {
        // if is logged in, redirect to the home page
        next({ path: '/' })
        NProgress.done()
      } else {
        //  从 vuex里面获取 权限组 如果有roles并且roles对象大于1个  为真的话说明已经登录过，直接跳下一步 
        const hasRoles = store.getters.roles && store.getters.roles.length > 0
        if (hasRoles) {
          next()
        } else {
          //  如果没有Roles，则请求API获取用户信息，拿到roles
          try {
            // const hasGetUserInfo = store.getters.name
            const { roles } = await store.dispatch('user/getInfo')
            
            // 根据Roles创建 使用权限筛选的路由
            const accessRoutes = await store.dispatch('permission/generateRoutes', roles)
  
            // router添加创建的路由
            router.addRoutes(accessRoutes)
  
            next({ ...to, replace: true })
  
          } catch (error) {
            // remove token and go to login page to re-login
            await store.dispatch('user/resetToken')
            Message.error(error || 'Has Error')
            next(`/login?redirect=${to.path}`)
            NProgress.done()
          }
        }
      }
  ```

- 新建创建路由的方法

  > src-store-modules下创建permission.js文件

  ![1632464171114](image\5C1632464171114.png)

  文件代码

  ```javascript
  import { asyncRoutes, constantRoutes } from '@/router'
  
  /**
   * Use meta.role to determine if the current user has permission
   * @param roles
   * @param route
   */
  function hasPermission(roles, route) {
    // 如果route下面没有mete也没有roles，则视为全部权限访问
    // 否则 用route的roles来遍历用户的 roles判断是否包含，包含则有权限。
    // 比如 route的权限是 ccc ,ddd  用户的权限是 aaa,bbb,ccc（可以视为3个部门） 则有权限访问， 
    if (route.meta && route.meta.roles) {
      return roles.some(role => route.meta.roles.includes(role))
    } else {
      return true
    }
  }
  
  /**
   * Filter asynchronous routing tables by recursion
   * @param routes asyncRoutes
   * @param roles
   */
  export function filterAsyncRoutes(routes, roles) {
    const res = []
    // 遍历筛选路由表，判断是否有权限,有权限则添加
    routes.forEach(route => {
      const tmp = { ...route }
      if (hasPermission(roles, tmp)) {
        if (tmp.children) {
          tmp.children = filterAsyncRoutes(tmp.children, roles)
        }
        res.push(tmp)
      }
    })
  
    return res
  }
  
  const state = {
    routes: [],
    addRoutes: []
  }
  
  const mutations = {
    SET_ROUTES: (state, routes) => {
      state.addRoutes = routes
      // 合并路由
      state.routes = constantRoutes.concat(routes)
      console.log('routes', state.routes)
    }
  }
  
  const actions = {
    // 创建筛选权限的路由
    generateRoutes({ commit }, roles) {
      return new Promise(resolve => {
        let accessedRoutes
        // 如果roles包含了 admin 权限路由直接等于 asyncRoutes
        if (roles.includes('admin')) {
          accessedRoutes = asyncRoutes || []
        } else {
          // 如果不是管理员 则进行路由过滤
          accessedRoutes = filterAsyncRoutes(asyncRoutes, roles)
        }
        commit('SET_ROUTES', accessedRoutes)
        resolve(accessedRoutes)
      })
    }
  }
  
  export default {
    namespaced: true,
    state,
    mutations,
    actions
  }
  
  
  ```

  在store中导入permission

  ![1632466471048](image\5C1632466471048.png)